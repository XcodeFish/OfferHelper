# AI面试助手桌面端技术架构设计

## 1. 整体架构

### 1.1 技术栈选择

- **主框架**: Electron + React + TypeScript
- **UI组件库**: Ant Design + Styled Components
- **状态管理**: Redux Toolkit + RTK Query
- **路由管理**: React Router
- **构建工具**: Webpack + Babel
- **代码规范**: ESLint + Prettier + Husky

### 1.2 架构分层

```
┌─────────────────────────────────────────┐
│              用户界面层 (UI Layer)        │
│         React Components + Ant Design   │
├─────────────────────────────────────────┤
│            业务逻辑层 (Business Layer)    │
│         Redux Store + Custom Hooks      │
├─────────────────────────────────────────┤
│            服务层 (Service Layer)        │
│      API Services + Electron Services   │
├─────────────────────────────────────────┤
│            数据层 (Data Layer)           │
│        Local Storage + Remote APIs      │
├─────────────────────────────────────────┤
│            系统层 (System Layer)         │
│         Electron Main Process           │
└─────────────────────────────────────────┘
```

## 2. 核心模块设计

### 2.1 主进程 (Main Process)

```typescript
// 主要职责
- 应用生命周期管理
- 窗口创建和管理
- 系统级API调用
- 全局快捷键注册
- 屏幕共享检测
- 音频权限管理
```

### 2.2 渲染进程 (Renderer Process)

```typescript
// 主要职责
- UI渲染和用户交互
- 业务逻辑处理
- 状态管理
- API调用
- 音频处理
```

### 2.3 进程间通信 (IPC)

```typescript
// 通信通道设计
interface IPCChannels {
  // 窗口控制
  'window:minimize': () => void;
  'window:hide': () => void;
  'window:setOpacity': (opacity: number) => void;
  'window:setAlwaysOnTop': (flag: boolean) => void;

  // 系统功能
  'system:registerShortcut': (shortcut: string, action: string) => void;
  'system:checkScreenShare': () => boolean;
  'system:requestMicPermission': () => Promise<boolean>;

  // 音频处理
  'audio:startListening': () => void;
  'audio:stopListening': () => void;
  'audio:getVolume': () => number;
}
```

## 3. 核心功能架构

### 3.1 屏幕共享规避系统

```typescript
// 检测机制
class ScreenShareDetector {
  private isScreenSharing: boolean = false;
  private checkInterval: NodeJS.Timeout;

  // 检测屏幕共享状态
  async detectScreenShare(): Promise<boolean> {
    // 使用 desktopCapturer API 检测
    const sources = await desktopCapturer.getSources({
      types: ['screen', 'window']
    });

    // 检测是否有应用在进行屏幕共享
    return this.analyzeCaptureSources(sources);
  }

  // 躲避策略
  async executeAvoidanceStrategy() {
    if (this.isScreenSharing) {
      // 隐藏窗口
      await ipcRenderer.invoke('window:hide');
      // 或者设置透明度为0
      await ipcRenderer.invoke('window:setOpacity', 0);
    }
  }
}
```

### 3.2 实时语音处理系统

```typescript
// 语音识别服务
class VoiceRecognitionService {
  private tencentCloudASR: TencentASR;
  private zhipuAI: ZhipuAIClient;

  // 开始语音监听
  async startListening() {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        sampleRate: 16000,
        channelCount: 1,
        echoCancellation: true,
        noiseSuppression: true
      }
    });

    // 连接腾讯云实时语音识别
    this.tencentCloudASR.connect(stream);
  }

  // 处理识别结果
  async processRecognitionResult(text: string) {
    // 发送到智谱AI获取回答
    const response = await this.zhipuAI.chat({
      messages: [{ role: 'user', content: text }],
      model: 'glm-4',
      stream: false
    });

    return response.choices[0].message.content;
  }
}
```

### 3.3 快捷键系统

```typescript
// 快捷键管理
class ShortcutManager {
  private shortcuts: Map<string, () => void> = new Map();

  // 注册快捷键
  registerShortcut(key: string, callback: () => void) {
    globalShortcut.register(key, callback);
    this.shortcuts.set(key, callback);
  }

  // 默认快捷键配置
  setupDefaultShortcuts() {
    this.registerShortcut('CommandOrControl+Shift+H', () => {
      // 隐藏/显示窗口
      this.toggleWindowVisibility();
    });

    this.registerShortcut('CommandOrControl+Shift+S', () => {
      // 开始/停止语音监听
      this.toggleVoiceListening();
    });
  }
}
```

## 4. 数据流设计

### 4.1 Redux Store 结构

```typescript
interface RootState {
  auth: {
    isLoggedIn: boolean;
    user: User | null;
    token: string | null;
  };

  app: {
    isListening: boolean;
    opacity: number;
    isHidden: boolean;
    isScreenSharing: boolean;
    currentMode: 'simple' | 'normal' | 'detailed';
  };

  voice: {
    isRecording: boolean;
    volume: number;
    lastRecognizedText: string;
    lastAIResponse: string;
  };

  settings: {
    opacity: number;
    autoHide: boolean;
    shortcuts: Record<string, string>;
    microphoneDevice: string;
  };
}
```

### 4.2 API 服务设计

```typescript
// API 服务基类
class BaseAPIService {
  protected baseURL: string;
  protected headers: Record<string, string>;

  constructor(baseURL: string) {
    this.baseURL = baseURL;
    this.headers = {
      'Content-Type': 'application/json',
    };
  }
}

// 认证服务
class AuthService extends BaseAPIService {
  async sendVerificationCode(email: string): Promise<void> {
    await this.post('/auth/send-code', { email });
  }

  async verifyCode(email: string, code: string): Promise<AuthResponse> {
    return await this.post('/auth/verify', { email, code });
  }
}

// AI 服务
class AIService extends BaseAPIService {
  async getResponse(
    text: string,
    mode: 'simple' | 'normal' | 'detailed'
  ): Promise<string> {
    return await this.post('/ai/chat', { text, mode });
  }
}
```

## 5. 安全设计

### 5.1 数据安全

- 敏感数据加密存储
- API密钥安全管理
- 用户认证token安全处理

### 5.2 权限管理

- 麦克风权限请求和管理
- 屏幕录制权限处理
- 系统级权限最小化原则

### 5.3 隐私保护

- 语音数据本地处理优先
- 用户数据匿名化
- 数据传输加密

## 6. 性能优化

### 6.1 内存优化

- 组件懒加载
- 音频流及时释放
- 定时器和监听器清理

### 6.2 启动优化

- 主进程预加载优化
- 渲染进程分包加载
- 资源按需加载

### 6.3 响应优化

- AI响应缓存机制
- 语音识别结果缓存
- UI状态防抖处理

## 7. 监控和日志

### 7.1 错误监控

- 崩溃报告收集
- 异常日志记录
- 性能指标监控

### 7.2 用户行为分析

- 功能使用统计
- 性能数据收集
- 用户反馈收集

## 8. 部署和更新

### 8.1 打包配置

- Electron Builder配置
- 代码签名设置
- 自动更新机制

### 8.2 版本管理

- 语义化版本控制
- 增量更新支持
- 回滚机制设计
