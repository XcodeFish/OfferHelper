# OfferHelperè¯­éŸ³æµ‹è¯•ç•Œé¢æ¶ˆå¤±é—®é¢˜ä¿®å¤

## ğŸ” é—®é¢˜ç°è±¡
ç”¨æˆ·åé¦ˆï¼šç‚¹å‡»"å¼€å§‹è¯†åˆ«"åç•Œé¢å°±æ¶ˆå¤±äº†ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼Œåº”ç”¨å˜æˆç™½å±çŠ¶æ€ã€‚

## ğŸ•µï¸ é—®é¢˜åˆ†æ

ç»è¿‡æ·±å…¥è°ƒè¯•å‘ç°ï¼Œè¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ **äº‹ä»¶ç³»ç»Ÿä¸åŒ¹é…**ï¼š

### é—®é¢˜ç»†èŠ‚ï¼š
1. `SpeechService.ts` ä¸­åŸæœ¬æœ‰è‡ªå·±çš„ `SimpleEventBus` å®ç°ï¼Œè¯¥å®ç°ä¼šåŒæ—¶å‘å°„ï¼š
   - EventBus è‡ªå®šä¹‰äº‹ä»¶ 
   - DOM è‡ªå®šä¹‰äº‹ä»¶ï¼ˆå¦‚ speechStart, speechEnd ç­‰ï¼‰

2. ä¹‹å‰çš„ä¿®å¤ä¸­ï¼Œæˆ‘ä»¬ç§»é™¤äº†é‡å¤çš„ `SimpleEventBus`ï¼Œç»Ÿä¸€ä½¿ç”¨ `src/shared/utils/EventBus.ts`

3. ä½†æ˜¯å…±äº«çš„ `EventBus` åªå‘å°„ EventBus äº‹ä»¶ï¼Œä¸å‘å°„ DOM äº‹ä»¶

4. è€Œ `SpeechMonitor.tsx` ç»„ä»¶ç›‘å¬çš„æ˜¯ DOM äº‹ä»¶ï¼š
   ```javascript
   document.addEventListener('speechStart', handleStart, eventOptions);
   document.addEventListener('speechEnd', handleEnd, eventOptions);
   // ç­‰ç­‰...
   ```

5. å› æ­¤å½“ `EventBus.emit('speech:started')` å‘å°„åï¼Œ`SpeechMonitor` æ”¶ä¸åˆ°å¯¹åº”çš„DOMäº‹ä»¶ï¼Œå¯¼è‡´ç•Œé¢çŠ¶æ€å¼‚å¸¸

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹å…±äº«çš„ `EventBus.ts`ï¼Œè®©å®ƒåŒæ—¶å‘å°„ DOM äº‹ä»¶ä»¥ä¿æŒå…¼å®¹æ€§ï¼š

```typescript
static emit(event: string, data?: any): void {
  console.log(`EventBus: å‘å°„äº‹ä»¶ ${event}`, data);
  
  // å‘å°„è‡ªå®šä¹‰äº‹ä»¶ç³»ç»Ÿ
  if (this.listeners[event]) {
    this.listeners[event].forEach(callback => {
      try {
        callback(data);
      } catch (error) {
        console.error(`EventBus: äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå¤±è´¥ [${event}]:`, error);
      }
    });
  }
  
  // åŒæ—¶å‘å°„DOMäº‹ä»¶ä»¥å…¼å®¹ç°æœ‰ç»„ä»¶
  if (typeof window !== 'undefined' && typeof document !== 'undefined') {
    try {
      // å°†è¯­éŸ³äº‹ä»¶æ˜ å°„åˆ°DOMäº‹ä»¶åç§°
      const domEventMap: { [key: string]: string } = {
        'speech:started': 'speechStart',
        'speech:ended': 'speechEnd', 
        'speech:error': 'speechError',
        'speech:result': 'speechTranscript',
        'speech:interim': 'speechInterimTranscript'
      };
      
      const domEventName = domEventMap[event] || event;
      const customEvent = new CustomEvent(domEventName, { detail: data });
      document.dispatchEvent(customEvent);
      console.log(`EventBus: DOMäº‹ä»¶å·²å‘å°„ ${domEventName}`);
    } catch (error) {
      console.error(`EventBus: DOMäº‹ä»¶å‘å°„å¤±è´¥ [${event}]:`, error);
    }
  }
}
```

## âœ… ä¿®å¤ç»“æœ

ç°åœ¨ EventBus ä¼šåŒæ—¶å‘å°„ï¼š
1. EventBus è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç»™å…¶ä»–ä½¿ç”¨ EventBus.on() çš„ç»„ä»¶ï¼‰
2. DOM è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç»™ä½¿ç”¨ document.addEventListener() çš„ç»„ä»¶å¦‚ SpeechMonitorï¼‰

è¿™æ ·å°±è§£å†³äº†äº‹ä»¶ç³»ç»Ÿä¸åŒ¹é…çš„é—®é¢˜ï¼Œè¯­éŸ³æµ‹è¯•ç•Œé¢åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºå’Œå“åº”äº†ã€‚

## ğŸ“ æµ‹è¯•å»ºè®®
1. é‡æ–°å¯åŠ¨åº”ç”¨
2. ç‚¹å‡»è®¾ç½® â†’ è¯­éŸ³æµ‹è¯•
3. ç‚¹å‡»"å¼€å§‹è¯†åˆ«"
4. è§‚å¯Ÿç•Œé¢æ˜¯å¦æ­£å¸¸æ˜¾ç¤ºå’Œå“åº”äº‹ä»¶

ç•Œé¢åº”è¯¥ä¸å†æ¶ˆå¤±ï¼Œèƒ½æ­£å¸¸æ˜¾ç¤ºè¯­éŸ³è¯†åˆ«çŠ¶æ€å’Œç»“æœã€‚