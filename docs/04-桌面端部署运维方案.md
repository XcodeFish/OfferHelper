# æ¡Œé¢ç«¯éƒ¨ç½²è¿ç»´æ–¹æ¡ˆ

## 1. éƒ¨ç½²æ¶æ„æ¦‚è§ˆ

### 1.1 éƒ¨ç½²æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å‘ç¯å¢ƒ       â”‚    â”‚   æ„å»ºç¯å¢ƒ       â”‚    â”‚   åˆ†å‘ç¯å¢ƒ       â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â€¢ ä»£ç å¼€å‘      â”‚â”€â”€â”€â–¶â”‚ â€¢ è‡ªåŠ¨æ„å»º      â”‚â”€â”€â”€â–¶â”‚ â€¢ åº”ç”¨ç­¾å      â”‚
â”‚ â€¢ æœ¬åœ°æµ‹è¯•      â”‚    â”‚ â€¢ è´¨é‡æ£€æŸ¥      â”‚    â”‚ â€¢ ç‰ˆæœ¬å‘å¸ƒ      â”‚
â”‚ â€¢ ä»£ç æäº¤      â”‚    â”‚ â€¢ å®‰å…¨æ‰«æ      â”‚    â”‚ â€¢ æ›´æ–°æ¨é€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰ˆæœ¬æ§åˆ¶       â”‚    â”‚   CI/CD æµæ°´çº¿   â”‚    â”‚   ç”¨æˆ·è®¾å¤‡       â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â€¢ Git ä»“åº“      â”‚    â”‚ â€¢ GitHub Actionsâ”‚    â”‚ â€¢ è‡ªåŠ¨æ›´æ–°      â”‚
â”‚ â€¢ åˆ†æ”¯ç®¡ç†      â”‚    â”‚ â€¢ æ„å»ºç¼“å­˜      â”‚    â”‚ â€¢ é”™è¯¯ä¸ŠæŠ¥      â”‚
â”‚ â€¢ ä»£ç å®¡æŸ¥      â”‚    â”‚ â€¢ æµ‹è¯•è¦†ç›–      â”‚    â”‚ â€¢ ä½¿ç”¨ç»Ÿè®¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

```json
{
  "æ„å»ºå·¥å…·": {
    "ä¸»æ„å»º": "Electron Builder",
    "æ‰“åŒ…": "Webpack 5",
    "ä»£ç å‹ç¼©": "Terser",
    "èµ„æºä¼˜åŒ–": "ImageMin"
  },
  "CI/CD": {
    "å¹³å°": "GitHub Actions",
    "ç¼“å­˜": "GitHub Cache",
    "åˆ¶å“å­˜å‚¨": "GitHub Releases",
    "é€šçŸ¥": "Slack/é’‰é’‰"
  },
  "åˆ†å‘æ¸ é“": {
    "å®˜æ–¹ç½‘ç«™": "ç›´æ¥ä¸‹è½½",
    "åº”ç”¨å•†åº—": "Microsoft Store, Mac App Store",
    "åŒ…ç®¡ç†å™¨": "Homebrew, Chocolatey, Snap",
    "ä¼ä¸šåˆ†å‘": "å†…éƒ¨æ›´æ–°æœåŠ¡å™¨"
  },
  "ç›‘æ§è¿ç»´": {
    "é”™è¯¯ç›‘æ§": "Sentry",
    "æ€§èƒ½ç›‘æ§": "Electron APM",
    "ä½¿ç”¨ç»Ÿè®¡": "Google Analytics",
    "æ—¥å¿—æ”¶é›†": "Winston + LogRocket"
  }
}
```

## 2. æ„å»ºé…ç½®

### 2.1 Electron Builder é…ç½®

```json
{
  "name": "offerhelper",
  "productName": "OfferHelper",
  "version": "1.0.0",
  "description": "ç¨‹åºå‘˜é¢è¯•AIè¾…åŠ©åŠ©æ‰‹",
  "main": "dist/main.js",
  "homepage": "https://offerhelper.com",
  "author": {
    "name": "OfferHelper Team",
    "email": "support@offerhelper.com"
  },
  "build": {
    "appId": "com.offerhelper.desktop",
    "productName": "OfferHelper",
    "copyright": "Copyright Â© 2024 OfferHelper Team",
    "directories": {
      "output": "release",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "extraResources": [
      {
        "from": "resources/",
        "to": "resources/",
        "filter": ["**/*"]
      }
    ],
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "build/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        },
        {
          "target": "zip",
          "arch": ["x64", "arm64"]
        }
      ]
    },
    "win": {
      "icon": "build/icon.ico",
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x64"]
        }
      ]
    },
    "linux": {
      "icon": "build/icon.png",
      "target": [
        {
          "target": "AppImage",
          "arch": ["x64"]
        },
        {
          "target": "deb",
          "arch": ["x64"]
        },
        {
          "target": "rpm",
          "arch": ["x64"]
        }
      ]
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "installerIcon": "build/icon.ico",
      "uninstallerIcon": "build/icon.ico",
      "installerHeaderIcon": "build/icon.ico",
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "OfferHelper"
    },
    "dmg": {
      "title": "OfferHelper ${version}",
      "icon": "build/icon.icns",
      "background": "build/dmg-background.png",
      "contents": [
        {
          "x": 130,
          "y": 220,
          "type": "file"
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ]
    },
    "publish": [
      {
        "provider": "github",
        "owner": "offerhelper",
        "repo": "desktop"
      }
    ]
  }
}
```

### 2.2 æ„å»ºè„šæœ¬

```json
{
  "scripts": {
    "dev": "concurrently \"npm run dev:main\" \"npm run dev:renderer\"",
    "dev:main": "webpack --config webpack.main.config.js --mode development --watch",
    "dev:renderer": "webpack serve --config webpack.renderer.config.js --mode development",
    "build": "npm run build:main && npm run build:renderer",
    "build:main": "webpack --config webpack.main.config.js --mode production",
    "build:renderer": "webpack --config webpack.renderer.config.js --mode production",
    "dist": "npm run build && electron-builder",
    "dist:mac": "npm run build && electron-builder --mac",
    "dist:win": "npm run build && electron-builder --win",
    "dist:linux": "npm run build && electron-builder --linux",
    "pack": "npm run build && electron-builder --dir",
    "postinstall": "electron-builder install-app-deps",
    "test": "jest",
    "test:e2e": "playwright test",
    "lint": "eslint src --ext .ts,.tsx",
    "lint:fix": "eslint src --ext .ts,.tsx --fix",
    "type-check": "tsc --noEmit",
    "clean": "rimraf dist release",
    "rebuild": "npm run clean && npm install && npm run build"
  }
}
```

### 2.3 Webpack é…ç½®

```javascript
// webpack.main.config.js
const path = require('path');

module.exports = {
  target: 'electron-main',
  entry: './src/main/main.ts',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'main.js'
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader',
        exclude: /node_modules/
      }
    ]
  },
  resolve: {
    extensions: ['.ts', '.js']
  },
  node: {
    __dirname: false,
    __filename: false
  },
  externals: {
    'better-sqlite3': 'commonjs better-sqlite3',
    'ffi-napi': 'commonjs ffi-napi'
  }
};

// webpack.renderer.config.js
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

module.exports = (env, argv) => {
  const isProduction = argv.mode === 'production';

  return {
    target: 'electron-renderer',
    entry: './src/renderer/index.tsx',
    output: {
      path: path.resolve(__dirname, 'dist'),
      filename: 'renderer.js'
    },
    module: {
      rules: [
        {
          test: /\.tsx?$/,
          use: 'ts-loader',
          exclude: /node_modules/
        },
        {
          test: /\.css$/,
          use: [
            isProduction ? MiniCssExtractPlugin.loader : 'style-loader',
            'css-loader',
            'postcss-loader'
          ]
        },
        {
          test: /\.(png|jpg|gif|svg)$/,
          type: 'asset/resource'
        }
      ]
    },
    resolve: {
      extensions: ['.tsx', '.ts', '.js'],
      alias: {
        '@': path.resolve(__dirname, 'src/renderer')
      }
    },
    plugins: [
      new HtmlWebpackPlugin({
        template: './src/renderer/index.html'
      }),
      ...(isProduction ? [new MiniCssExtractPlugin()] : [])
    ],
    devServer: {
      port: 3000,
      hot: true
    }
  };
};
```

## 3. CI/CD æµæ°´çº¿

### 3.1 GitHub Actions é…ç½®

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm test

      - name: Run E2E tests
        run: npm run test:e2e

  build:
    needs: test
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build distributables
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-${{ matrix.os }}
          path: release/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-macos-latest/**/*
            dist-windows-latest/**/*
            dist-ubuntu-latest/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 3.2 ä»£ç è´¨é‡æ£€æŸ¥

```yaml
# .github/workflows/quality.yml
name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format=json --output-file=eslint-report.json
        continue-on-error: true

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,css,md}"

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run dependency check
        run: npx depcheck

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

### 3.3 è‡ªåŠ¨åŒ–æµ‹è¯•

```yaml
# .github/workflows/test.yml
name: Automated Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --coverage --watchAll=false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  e2e-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Install Playwright
        run: npx playwright install

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report-${{ matrix.os }}
          path: playwright-report/
```

## 4. ä»£ç ç­¾åä¸å®‰å…¨

### 4.1 macOS ä»£ç ç­¾å

```xml
<!-- build/entitlements.mac.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>com.apple.security.cs.allow-jit</key>
  <true/>
  <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
  <true/>
  <key>com.apple.security.cs.disable-library-validation</key>
  <true/>
  <key>com.apple.security.device.microphone</key>
  <true/>
  <key>com.apple.security.device.camera</key>
  <false/>
  <key>com.apple.security.network.client</key>
  <true/>
  <key>com.apple.security.network.server</key>
  <false/>
  <key>com.apple.security.files.user-selected.read-write</key>
  <true/>
</dict>
</plist>
```

```bash
# ç­¾åè„šæœ¬
#!/bin/bash

# è®¾ç½®ç¯å¢ƒå˜é‡
export CSC_LINK="path/to/certificate.p12"
export CSC_KEY_PASSWORD="certificate_password"
export APPLE_ID="developer@example.com"
export APPLE_ID_PASSWORD="app_specific_password"

# æ„å»ºå¹¶ç­¾å
npm run dist:mac

# å…¬è¯åº”ç”¨
xcrun altool --notarize-app \
  --primary-bundle-id "com.offerhelper.desktop" \
  --username "$APPLE_ID" \
  --password "$APPLE_ID_PASSWORD" \
  --file "release/OfferHelper-1.0.0.dmg"
```

### 4.2 Windows ä»£ç ç­¾å

```javascript
// ç­¾åé…ç½®
const { execSync } = require('child_process');
const path = require('path');

function signWindows() {
  const signtool = 'C:\\Program Files (x86)\\Windows Kits\\10\\bin\\10.0.19041.0\\x64\\signtool.exe';
  const certificate = process.env.WIN_CSC_LINK;
  const password = process.env.WIN_CSC_KEY_PASSWORD;

  const files = [
    'release/OfferHelper Setup 1.0.0.exe',
    'release/OfferHelper 1.0.0.exe'
  ];

  files.forEach(file => {
    if (require('fs').existsSync(file)) {
      const command = `"${signtool}" sign /f "${certificate}" /p "${password}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "${file}"`;
      execSync(command, { stdio: 'inherit' });
      console.log(`å·²ç­¾å: ${file}`);
    }
  });
}

module.exports = { signWindows };
```

### 4.3 å®‰å…¨æ£€æŸ¥è„šæœ¬

```javascript
// scripts/security-check.js
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

class SecurityChecker {
  constructor() {
    this.vulnerabilities = [];
    this.securityRules = [
      this.checkHardcodedSecrets,
      this.checkInsecureProtocols,
      this.checkDangerousPermissions,
      this.checkOutdatedDependencies
    ];
  }

  async runAllChecks() {
    console.log('ğŸ” å¼€å§‹å®‰å…¨æ£€æŸ¥...');

    for (const rule of this.securityRules) {
      await rule.call(this);
    }

    this.generateReport();
  }

  checkHardcodedSecrets() {
    const patterns = [
      /api[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /secret[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /password\s*[:=]\s*['"][^'"]+['"]/gi,
      /token\s*[:=]\s*['"][^'"]+['"]/gi
    ];

    this.scanFiles('src', patterns, 'ç¡¬ç¼–ç å¯†é’¥');
  }

  checkInsecureProtocols() {
    const patterns = [
      /http:\/\/(?!localhost|127\.0\.0\.1)/gi,
      /ftp:\/\//gi
    ];

    this.scanFiles('src', patterns, 'ä¸å®‰å…¨åè®®');
  }

  checkDangerousPermissions() {
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const dangerousPerms = [
      'nodeIntegration: true',
      'contextIsolation: false',
      'webSecurity: false'
    ];

    // æ£€æŸ¥æ˜¯å¦æœ‰å±é™©çš„ Electron é…ç½®
    this.scanFiles('src', dangerousPerms.map(p => new RegExp(p, 'gi')), 'å±é™©æƒé™');
  }

  async checkOutdatedDependencies() {
    try {
      const { execSync } = require('child_process');
      const auditResult = execSync('npm audit --json', { encoding: 'utf8' });
      const audit = JSON.parse(auditResult);

      if (audit.metadata.vulnerabilities.total > 0) {
        this.vulnerabilities.push({
          type: 'ä¾èµ–æ¼æ´',
          count: audit.metadata.vulnerabilities.total,
          details: audit.advisories
        });
      }
    } catch (error) {
      console.warn('ä¾èµ–æ£€æŸ¥å¤±è´¥:', error.message);
    }
  }

  scanFiles(dir, patterns, type) {
    const files = this.getAllFiles(dir);

    files.forEach(file => {
      const content = fs.readFileSync(file, 'utf8');

      patterns.forEach(pattern => {
        const matches = content.match(pattern);
        if (matches) {
          this.vulnerabilities.push({
            type,
            file,
            matches: matches.length,
            details: matches
          });
        }
      });
    });
  }

  getAllFiles(dir) {
    let files = [];
    const items = fs.readdirSync(dir);

    items.forEach(item => {
      const fullPath = path.join(dir, item);
      const stat = fs.statSync(fullPath);

      if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
        files = files.concat(this.getAllFiles(fullPath));
      } else if (stat.isFile() && /\.(js|ts|tsx|jsx)$/.test(item)) {
        files.push(fullPath);
      }
    });

    return files;
  }

  generateReport() {
    console.log('\nğŸ“Š å®‰å…¨æ£€æŸ¥æŠ¥å‘Š');
    console.log('='.repeat(50));

    if (this.vulnerabilities.length === 0) {
      console.log('âœ… æœªå‘ç°å®‰å…¨é—®é¢˜');
      return;
    }

    this.vulnerabilities.forEach((vuln, index) => {
      console.log(`\n${index + 1}. ${vuln.type}`);
      if (vuln.file) {
        console.log(`   æ–‡ä»¶: ${vuln.file}`);
        console.log(`   åŒ¹é…: ${vuln.matches} ä¸ª`);
      }
      if (vuln.count) {
        console.log(`   æ•°é‡: ${vuln.count}`);
      }
    });

    console.log(`\nâš ï¸  æ€»è®¡å‘ç° ${this.vulnerabilities.length} ä¸ªå®‰å…¨é—®é¢˜`);

    // å¦‚æœæœ‰é«˜å±æ¼æ´ï¼Œé€€å‡ºæ„å»º
    const criticalIssues = this.vulnerabilities.filter(v =>
      v.type === 'ç¡¬ç¼–ç å¯†é’¥' || v.type === 'å±é™©æƒé™'
    );

    if (criticalIssues.length > 0) {
      console.error('âŒ å‘ç°é«˜å±å®‰å…¨é—®é¢˜ï¼Œæ„å»ºç»ˆæ­¢');
      process.exit(1);
    }
  }
}

// è¿è¡Œå®‰å…¨æ£€æŸ¥
if (require.main === module) {
  const checker = new SecurityChecker();
  checker.runAllChecks();
}

module.exports = SecurityChecker;
```

## 5. è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ

### 5.1 æ›´æ–°æœåŠ¡å™¨é…ç½®

```javascript
// update-server/server.js
const express = require('express');
const semver = require('semver');
const app = express();

// ç‰ˆæœ¬ä¿¡æ¯å­˜å‚¨
const versions = {
  'darwin': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-x64.zip',
      signature: 'signature_hash_here'
    },
    'arm64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-arm64.zip',
      signature: 'signature_hash_here'
    }
  },
  'win32': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-win-x64.exe',
      signature: 'signature_hash_here'
    }
  },
  'linux': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-linux-x64.AppImage',
      signature: 'signature_hash_here'
    }
  }
};

// æ£€æŸ¥æ›´æ–°æ¥å£
app.get('/update/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  const platformVersions = versions[platform];
  if (!platformVersions) {
    return res.status(404).json({ error: 'Platform not supported' });
  }

  const archVersion = platformVersions[arch];
  if (!archVersion) {
    return res.status(404).json({ error: 'Architecture not supported' });
  }

  // æ¯”è¾ƒç‰ˆæœ¬
  if (semver.gt(archVersion.version, version)) {
    res.json({
      version: archVersion.version,
      url: archVersion.url,
      signature: archVersion.signature,
      releaseNotes: `æ›´æ–°åˆ°ç‰ˆæœ¬ ${archVersion.version}`
    });
  } else {
    res.status(204).send(); // æ— æ›´æ–°
  }
});

// ä¸‹è½½ç»Ÿè®¡
app.get('/download/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  // è®°å½•ä¸‹è½½ç»Ÿè®¡
  console.log(`ä¸‹è½½: ${platform}-${arch}-${version}`);

  // é‡å®šå‘åˆ°å®é™…ä¸‹è½½åœ°å€
  const platformVersions = versions[platform];
  const archVersion = platformVersions?.[arch];

  if (archVersion && archVersion.version === version) {
    res.redirect(archVersion.url);
  } else {
    res.status(404).json({ error: 'Version not found' });
  }
});

app.listen(3001, () => {
  console.log('æ›´æ–°æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 3001');
});
```

### 5.2 å®¢æˆ·ç«¯æ›´æ–°é€»è¾‘

```typescript
// src/main/updater.ts
import { autoUpdater } from 'electron-updater';
import { dialog, BrowserWindow } from 'electron';
import log from 'electron-log';

class AppUpdater {
  private mainWindow: BrowserWindow;
  private updateCheckInterval: NodeJS.Timeout | null = null;

  constructor(mainWindow: BrowserWindow) {
    this.mainWindow = mainWindow;
    this.setupUpdater();
  }

  private setupUpdater(): void {
    // é…ç½®æ›´æ–°æœåŠ¡å™¨
    autoUpdater.setFeedURL({
      provider: 'generic',
      url: 'https://api.offerhelper.com/updates'
    });

    // é…ç½®æ—¥å¿—
    autoUpdater.logger = log;
    (autoUpdater.logger as any).transports.file.level = 'info';

    // äº‹ä»¶ç›‘å¬
    autoUpdater.on('checking-for-update', () => {
      log.info('æ£€æŸ¥æ›´æ–°ä¸­...');
      this.sendStatusToWindow('checking-for-update');
    });

    autoUpdater.on('update-available', (info) => {
      log.info('å‘ç°æ–°ç‰ˆæœ¬:', info.version);
      this.sendStatusToWindow('update-available', info);
      this.showUpdateDialog(info);
    });

    autoUpdater.on('update-not-available', (info) => {
      log.info('å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
      this.sendStatusToWindow('update-not-available', info);
    });

    autoUpdater.on('error', (err) => {
      log.error('æ›´æ–°é”™è¯¯:', err);
      this.sendStatusToWindow('update-error', err);
    });

    autoUpdater.on('download-progress', (progressObj) => {
      let logMessage = `ä¸‹è½½é€Ÿåº¦: ${progressObj.bytesPerSecond}`;
      logMessage += ` - å·²ä¸‹è½½ ${progressObj.percent}%`;
      logMessage += ` (${progressObj.transferred}/${progressObj.total})`;

      log.info(logMessage);
      this.sendStatusToWindow('download-progress', progressObj);
    });

    autoUpdater.on('update-downloaded', (info) => {
      log.info('æ›´æ–°ä¸‹è½½å®Œæˆ');
      this.sendStatusToWindow('update-downloaded', info);
      this.showRestartDialog();
    });
  }

  public checkForUpdates(): void {
    autoUpdater.checkForUpdatesAndNotify();
  }

  public startAutoCheck(): void {
    // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
    this.updateCheckInterval = setInterval(() => {
      this.checkForUpdates();
    }, 60 * 60 * 1000);

    // å¯åŠ¨æ—¶æ£€æŸ¥
    setTimeout(() => {
      this.checkForUpdates();
    }, 5000);
  }

  public stopAutoCheck(): void {
    if (this.updateCheckInterval) {
      clearInterval(this.updateCheckInterval);
      this.updateCheckInterval = null;
    }
  }

  private sendStatusToWindow(event: string, data?: any): void {
    if (this.mainWindow && !this.mainWindow.isDestroyed()) {
      this.mainWindow.webContents.send('updater-message', { event, data });
    }
  }

  private showUpdateDialog(info: any): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['ç«‹å³æ›´æ–°', 'ç¨åæé†’', 'è·³è¿‡æ­¤ç‰ˆæœ¬'],
      defaultId: 0,
      title: 'å‘ç°æ–°ç‰ˆæœ¬',
      message: `å‘ç°æ–°ç‰ˆæœ¬ ${info.version}`,
      detail: 'æ˜¯å¦ç«‹å³ä¸‹è½½å¹¶å®‰è£…æ›´æ–°ï¼Ÿ'
    });

    switch (response) {
      case 0: // ç«‹å³æ›´æ–°
        autoUpdater.downloadUpdate();
        break;
      case 1: // ç¨åæé†’
        // 1å°æ—¶åå†æ¬¡æé†’
        setTimeout(() => {
          this.showUpdateDialog(info);
        }, 60 * 60 * 1000);
        break;
      case 2: // è·³è¿‡æ­¤ç‰ˆæœ¬
        // è®°å½•è·³è¿‡çš„ç‰ˆæœ¬
        this.skipVersion(info.version);
        break;
    }
  }

  private showRestartDialog(): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['ç«‹å³é‡å¯', 'ç¨åé‡å¯'],
      defaultId: 0,
      title: 'æ›´æ–°å·²ä¸‹è½½',
      message: 'æ›´æ–°å·²ä¸‹è½½å®Œæˆ',
      detail: 'éœ€è¦é‡å¯åº”ç”¨ä»¥å®Œæˆæ›´æ–°ã€‚'
    });

    if (response === 0) {
      autoUpdater.quitAndInstall();
    }
  }

  private skipVersion(version: string): void {
    // å°†è·³è¿‡çš„ç‰ˆæœ¬ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    const { app } = require('electron');
    const fs = require('fs');
    const path = require('path');

    const configPath = path.join(app.getPath('userData'), 'update-config.json');
    let config = {};

    try {
      if (fs.existsSync(configPath)) {
        config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
      }
    } catch (error) {
      log.error('è¯»å–æ›´æ–°é…ç½®å¤±è´¥:', error);
    }

    config.skippedVersions = config.skippedVersions || [];
    if (!config.skippedVersions.includes(version)) {
      config.skippedVersions.push(version);
    }

    try {
      fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    } catch (error) {
      log.error('ä¿å­˜æ›´æ–°é…ç½®å¤±è´¥:', error);
    }
  }
}

export default AppUpdater;
```

### 5.3 æ¸²æŸ“è¿›ç¨‹æ›´æ–°ç•Œé¢

```tsx
// src/renderer/components/UpdateNotification.tsx
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface UpdateInfo {
  version: string;
  releaseNotes?: string;
}

interface UpdateProgress {
  percent: number;
  bytesPerSecond: number;
  transferred: number;
  total: number;
}

const UpdateNotification: React.FC = () => {
  const [updateState, setUpdateState] = useState<string>('');
  const [updateInfo, setUpdateInfo] = useState<UpdateInfo | null>(null);
  const [downloadProgress, setDownloadProgress] = useState<UpdateProgress | null>(null);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    // ç›‘å¬æ›´æ–°äº‹ä»¶
    const handleUpdaterMessage = (event: any, { event: updateEvent, data }: any) => {
      setUpdateState(updateEvent);

      switch (updateEvent) {
        case 'update-available':
          setUpdateInfo(data);
          setIsVisible(true);
          break;
        case 'download-progress':
          setDownloadProgress(data);
          break;
        case 'update-downloaded':
          setDownloadProgress(null);
          break;
        case 'update-not-available':
        case 'update-error':
          setTimeout(() => setIsVisible(false), 3000);
          break;
      }
    };

    window.electron?.ipcRenderer.on('updater-message', handleUpdaterMessage);

    return () => {
      window.electron?.ipcRenderer.removeListener('updater-message', handleUpdaterMessage);
    };
  }, []);

  const getStatusText = () => {
    switch (updateState) {
      case 'checking-for-update':
        return 'æ£€æŸ¥æ›´æ–°ä¸­...';
      case 'update-available':
        return `å‘ç°æ–°ç‰ˆæœ¬ ${updateInfo?.version}`;
      case 'download-progress':
        return `ä¸‹è½½ä¸­... ${Math.round(downloadProgress?.percent || 0)}%`;
      case 'update-downloaded':
        return 'æ›´æ–°å·²ä¸‹è½½å®Œæˆ';
      case 'update-not-available':
        return 'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬';
      case 'update-error':
        return 'æ›´æ–°æ£€æŸ¥å¤±è´¥';
      default:
        return '';
    }
  };

  const formatBytes = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const formatSpeed = (bytesPerSecond: number) => {
    return formatBytes(bytesPerSecond) + '/s';
  };

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          className="update-notification"
          initial={{ opacity: 0, y: -50 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -50 }}
          transition={{ duration: 0.3 }}
        >
          <div className="update-content">
            <div className="update-icon">
              {updateState === 'checking-for-update' && 'ğŸ”'}
              {updateState === 'update-available' && 'ğŸ‰'}
              {updateState === 'download-progress' && 'â¬‡ï¸'}
              {updateState === 'update-downloaded' && 'âœ…'}
              {updateState === 'update-not-available' && 'â„¹ï¸'}
              {updateState === 'update-error' && 'âŒ'}
            </div>

            <div className="update-info">
              <div className="update-title">{getStatusText()}</div>

              {downloadProgress && (
                <div className="download-info">
                  <div className="progress-bar">
                    <div
                      className="progress-fill"
                      style={{ width: `${downloadProgress.percent}%` }}
                    />
                  </div>
                  <div className="download-stats">
                    <span>{formatBytes(downloadProgress.transferred)} / {formatBytes(downloadProgress.total)}</span>
                    <span>{formatSpeed(downloadProgress.bytesPerSecond)}</span>
                  </div>
                </div>
              )}

              {updateInfo?.releaseNotes && (
                <div className="release-notes">
                  {updateInfo.releaseNotes}
                </div>
              )}
            </div>

            <button
              className="close-btn"
              onClick={() => setIsVisible(false)}
            >
              Ã—
            </button>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default UpdateNotification;
```

## 6. ç›‘æ§ä¸æ—¥å¿—ç³»ç»Ÿ

### 6.1 é”™è¯¯ç›‘æ§é…ç½®

```typescript
// src/main/monitoring.ts
import * as Sentry from '@sentry/electron';
import { app } from 'electron';

class MonitoringService {
  private isInitialized = false;

  public initialize(): void {
    if (this.isInitialized) return;

    // åˆå§‹åŒ– Sentry
    Sentry.init({
      dsn: process.env.SENTRY_DSN,
      environment: process.env.NODE_ENV || 'development',
      release: app.getVersion(),
      beforeSend: this.filterSensitiveData,
      integrations: [
        new Sentry.Integrations.MainThreadProfiling(),
      ],
      tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    });

    // è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
    Sentry.setContext('app', {
      name: app.getName(),
      version: app.getVersion(),
      platform: process.platform,
      arch: process.arch,
    });

    this.isInitialized = true;
  }

  private filterSensitiveData(event: Sentry.Event): Sentry.Event | null {
    // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
    if (event.exception) {
      event.exception.values?.forEach(exception => {
        if (exception.stacktrace?.frames) {
          exception.stacktrace.frames.forEach(frame => {
            // ç§»é™¤æ–‡ä»¶è·¯å¾„ä¸­çš„ç”¨æˆ·ä¿¡æ¯
            if (frame.filename) {
              frame.filename = frame.filename.replace(/\/Users\/[^\/]+/, '/Users/***');
              frame.filename = frame.filename.replace(/C:\\Users\\[^\\]+/, 'C:\\Users\\***');
            }
          });
        }
      });
    }

    // è¿‡æ»¤åŒ…å«å¯†é’¥çš„é”™è¯¯
    const sensitiveKeywords = ['password', 'token', 'key', 'secret'];
    const errorMessage = event.message || '';

    if (sensitiveKeywords.some(keyword =>
      errorMessage.toLowerCase().includes(keyword)
    )) {
      return null; // ä¸å‘é€åŒ…å«æ•æ„Ÿä¿¡æ¯çš„é”™è¯¯
    }

    return event;
  }

  public captureException(error: Error, context?: any): void {
    if (!this.isInitialized) return;

    Sentry.withScope(scope => {
      if (context) {
        scope.setContext('additional', context);
      }
      Sentry.captureException(error);
    });
  }

  public captureMessage(message: string, level: Sentry.SeverityLevel = 'info'): void {
    if (!this.isInitialized) return;

    Sentry.captureMessage(message, level);
  }

  public setUser(user: { id: string; email?: string }): void {
    if (!this.isInitialized) return;

    Sentry.setUser(user);
  }

  public addBreadcrumb(breadcrumb: Sentry.Breadcrumb): void {
    if (!this.isInitialized) return;

    Sentry.addBreadcrumb(breadcrumb);
  }
}

export const monitoring = new MonitoringService();
```

### 6.2 æ€§èƒ½ç›‘æ§

```typescript
// src/main/performance.ts
import { app, powerMonitor } from 'electron';
import * as os from 'os';

interface PerformanceMetrics {
  timestamp: number;
  memory: {
    heapUsed: number;
    heapTotal: number;
    external: number;
    rss: number;
  };
  cpu: {
    usage: number;
    loadAverage: number[];
  };
  system: {
    platform: string;
    arch: string;
    totalMemory: number;
    freeMemory: number;
    uptime: number;
  };
  app: {
    version: string;
    uptime: number;
    isOnBattery?: boolean;
  };
}

class PerformanceMonitor {
  private metrics: PerformanceMetrics[] = [];
  private intervalId: NodeJS.Timeout | null = null;
  private readonly maxMetrics = 1000; // ä¿ç•™æœ€è¿‘1000æ¡è®°å½•

  public start(): void {
    if (this.intervalId) return;

    // æ¯30ç§’æ”¶é›†ä¸€æ¬¡æ€§èƒ½æ•°æ®
    this.intervalId = setInterval(() => {
      this.collectMetrics();
    }, 30000);

    // ç«‹å³æ”¶é›†ä¸€æ¬¡
    this.collectMetrics();
  }

  public stop(): void {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
  }

  private collectMetrics(): void {
    const memUsage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();

    const metrics: PerformanceMetrics = {
      timestamp: Date.now(),
      memory: {
        heapUsed: memUsage.heapUsed,
        heapTotal: memUsage.heapTotal,
        external: memUsage.external,
        rss: memUsage.rss,
      },
      cpu: {
        usage: this.calculateCpuUsage(cpuUsage),
        loadAverage: os.loadavg(),
      },
      system: {
        platform: os.platform(),
        arch: os.arch(),
        totalMemory: os.totalmem(),
        freeMemory: os.freemem(),
        uptime: os.uptime(),
      },
      app: {
        version: app.getVersion(),
        uptime: process.uptime(),
        isOnBattery: powerMonitor.isOnBatteryPower?.(),
      },
    };

    this.metrics.push(metrics);

    // ä¿æŒæ•°ç»„å¤§å°
    if (this.metrics.length > this.maxMetrics) {
      this.metrics.shift();
    }

    // æ£€æŸ¥æ€§èƒ½è­¦å‘Š
    this.checkPerformanceWarnings(metrics);
  }

  private calculateCpuUsage(cpuUsage: NodeJS.CpuUsage): number {
    // ç®€åŒ–çš„CPUä½¿ç”¨ç‡è®¡ç®—
    const totalUsage = cpuUsage.user + cpuUsage.system;
    return totalUsage / 1000000; // è½¬æ¢ä¸ºæ¯«ç§’
  }

  private checkPerformanceWarnings(metrics: PerformanceMetrics): void {
    // å†…å­˜ä½¿ç”¨è­¦å‘Š
    const memoryUsageMB = metrics.memory.heapUsed / 1024 / 1024;
    if (memoryUsageMB > 200) {
      console.warn(`å†…å­˜ä½¿ç”¨è¿‡é«˜: ${memoryUsageMB.toFixed(2)}MB`);

      // å‘é€åˆ°ç›‘æ§æœåŠ¡
      monitoring.captureMessage(
        `é«˜å†…å­˜ä½¿ç”¨: ${memoryUsageMB.toFixed(2)}MB`,
        'warning'
      );
    }

    // CPUä½¿ç”¨è­¦å‘Š
    if (metrics.cpu.usage > 80) {
      console.warn(`CPUä½¿ç”¨ç‡è¿‡é«˜: ${metrics.cpu.usage.toFixed(2)}%`);

      monitoring.captureMessage(
        `é«˜CPUä½¿ç”¨: ${metrics.cpu.usage.toFixed(2)}%`,
        'warning'
      );
    }

    // ç³»ç»Ÿå†…å­˜ä¸è¶³è­¦å‘Š
    const freeMemoryPercent = (metrics.system.freeMemory / metrics.system.totalMemory) * 100;
    if (freeMemoryPercent < 10) {
      console.warn(`ç³»ç»Ÿå†…å­˜ä¸è¶³: ${freeMemoryPercent.toFixed(2)}%`);

      monitoring.captureMessage(
        `ç³»ç»Ÿå†…å­˜ä¸è¶³: ${freeMemoryPercent.toFixed(2)}%`,
        'warning'
      );
    }
  }

  public getMetrics(): PerformanceMetrics[] {
    return [...this.metrics];
  }

  public getLatestMetrics(): PerformanceMetrics | null {
    return this.metrics.length > 0 ? this.metrics[this.metrics.length - 1] : null;
  }

  public getAverageMetrics(minutes: number = 5): Partial<PerformanceMetrics> | null {
    const cutoffTime = Date.now() - (minutes * 60 * 1000);
    const recentMetrics = this.metrics.filter(m => m.timestamp > cutoffTime);

    if (recentMetrics.length === 0) return null;

    const avgMemory = recentMetrics.reduce((sum, m) => sum + m.memory.heapUsed, 0) / recentMetrics.length;
    const avgCpu = recentMetrics.reduce((sum, m) => sum + m.cpu.usage, 0) / recentMetrics.length;

    return {
      memory: {
        heapUsed: avgMemory,
        heapTotal: 0,
        external: 0,
        rss: 0,
      },
      cpu: {
        usage: avgCpu,
        loadAverage: [],
      },
    };
  }
}

export const performanceMonitor = new PerformanceMonitor();
```

### 6.3 ä½¿ç”¨ç»Ÿè®¡

```typescript
// src/main/analytics.ts
import { app, ipcMain } from 'electron';
import * as path from 'path';
import * as fs from 'fs';

interface UsageEvent {
  event: string;
  properties?: Record<string, any>;
  timestamp: number;
  sessionId: string;
  userId?: string;
}

interface SessionInfo {
  sessionId: string;
  startTime: number;
  endTime?: number;
  events: UsageEvent[];
  userAgent: string;
  version: string;
}

class AnalyticsService {
  private currentSession: SessionInfo | null = null;
  private userId: string | null = null;
  private analyticsPath: string;
  private batchSize = 50;
  private flushInterval = 60000; // 1åˆ†é’Ÿ
  private flushTimer: NodeJS.Timeout | null = null;

  constructor() {
    this.analyticsPath = path.join(app.getPath('userData'), 'analytics');
    this.ensureAnalyticsDirectory();
    this.setupIpcHandlers();
  }

  private ensureAnalyticsDirectory(): void {
    if (!fs.existsSync(this.analyticsPath)) {
      fs.mkdirSync(this.analyticsPath, { recursive: true });
    }
  }

  private setupIpcHandlers(): void {
    ipcMain.handle('analytics:track', (event, eventName: string, properties?: Record<string, any>) => {
      this.track(eventName, properties);
    });

    ipcMain.handle('analytics:setUser', (event, userId: string) => {
      this.setUserId(userId);
    });
  }

  public startSession(): void {
    this.currentSession = {
      sessionId: this.generateSessionId(),
      startTime: Date.now(),
      events: [],
      userAgent: `OfferHelper/${app.getVersion()} (${process.platform})`,
      version: app.getVersion(),
    };

    this.track('session_start');
    this.startFlushTimer();
  }

  public endSession(): void {
    if (this.currentSession) {
      this.currentSession.endTime = Date.now();
      this.track('session_end');
      this.flush();
      this.currentSession = null;
    }

    this.stopFlushTimer();
  }

  public track(event: string, properties?: Record<string, any>): void {
    if (!this.currentSession) return;

    const usageEvent: UsageEvent = {
      event,
      properties,
      timestamp: Date.now(),
      sessionId: this.currentSession.sessionId,
      userId: this.userId || undefined,
    };

    this.currentSession.events.push(usageEvent);

    // è‡ªåŠ¨åˆ·æ–°å¤§æ‰¹é‡äº‹ä»¶
    if (this.currentSession.events.length >= this.batchSize) {
      this.flush();
    }
  }

  public setUserId(userId: string): void {
    this.userId = userId;
  }

  private flush(): void {
    if (!this.currentSession || this.currentSession.events.length === 0) return;

    const sessionData = { ...this.currentSession };
    const filename = `session_${sessionData.sessionId}_${Date.now()}.json`;
    const filepath = path.join(this.analyticsPath, filename);

    try {
      fs.writeFileSync(filepath, JSON.stringify(sessionData, null, 2));
      console.log(`åˆ†ææ•°æ®å·²ä¿å­˜: ${filename}`);

      // æ¸…ç©ºå½“å‰ä¼šè¯çš„äº‹ä»¶
      this.currentSession.events = [];

      // å°è¯•ä¸Šä¼ æ•°æ®
      this.uploadAnalyticsData();
    } catch (error) {
      console.error('ä¿å­˜åˆ†ææ•°æ®å¤±è´¥:', error);
    }
  }

  private async uploadAnalyticsData(): void {
    try {
      const files = fs.readdirSync(this.analyticsPath)
        .filter(file => file.endsWith('.json'))
        .slice(0, 10); // æ¯æ¬¡æœ€å¤šä¸Šä¼ 10ä¸ªæ–‡ä»¶

      for (const file of files) {
        const filepath = path.join(this.analyticsPath, file);
        const data = JSON.parse(fs.readFileSync(filepath, 'utf8'));

        // å‘é€åˆ°åˆ†ææœåŠ¡
        const response = await fetch('https://api.offerhelper.com/analytics', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'User-Agent': data.userAgent,
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // ä¸Šä¼ æˆåŠŸï¼Œåˆ é™¤æœ¬åœ°æ–‡ä»¶
          fs.unlinkSync(filepath);
          console.log(`åˆ†ææ•°æ®ä¸Šä¼ æˆåŠŸ: ${file}`);
        } else {
          console.warn(`åˆ†ææ•°æ®ä¸Šä¼ å¤±è´¥: ${file}`, response.status);
          break; // åœæ­¢ä¸Šä¼ å…¶ä»–æ–‡ä»¶
        }
      }
    } catch (error) {
      console.error('ä¸Šä¼ åˆ†ææ•°æ®å¤±è´¥:', error);
    }
  }

  private startFlushTimer(): void {
    this.flushTimer = setInterval(() => {
      this.flush();
    }, this.flushInterval);
  }

  private stopFlushTimer(): void {
    if (this.flushTimer) {
      clearInterval(this.flushTimer);
      this.flushTimer = null;
    }
  }

  private generateSessionId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  // é¢„å®šä¹‰çš„äº‹ä»¶è·Ÿè¸ªæ–¹æ³•
  public trackAppLaunch(): void {
    this.track('app_launch', {
      platform: process.platform,
      arch: process.arch,
      version: app.getVersion(),
    });
  }

  public trackFeatureUsage(feature: string, duration?: number): void {
    this.track('feature_usage', {
      feature,
      duration,
    });
  }

  public trackError(error: Error, context?: string): void {
    this.track('error', {
      message: error.message,
      stack: error.stack,
      context,
    });
  }

  public trackPerformance(metric: string, value: number, unit: string): void {
    this.track('performance', {
      metric,
      value,
      unit,
    });
  }
}

export const analytics = new AnalyticsService();
```

## 7. è¿ç»´ç›‘æ§é¢æ¿

### 7.1 ç›‘æ§é¢æ¿ç•Œé¢

```tsx
// src/renderer/components/MonitoringDashboard.tsx
import React, { useState, useEffect } from 'react';
import { Line, Bar, Doughnut } from 'react-chartjs-2';

interface MonitoringDashboardProps {
  isVisible: boolean;
  onClose: () => void;
}

const MonitoringDashboard: React.FC<MonitoringDashboardProps> = ({
  isVisible,
  onClose
}) => {
  const [metrics, setMetrics] = useState<any[]>([]);
  const [systemInfo, setSystemInfo] = useState<any>(null);
  const [errors, setErrors] = useState<any[]>([]);

  useEffect(() => {
    if (isVisible) {
      loadMonitoringData();
      const interval = setInterval(loadMonitoringData, 5000);
      return () => clearInterval(interval);
    }
  }, [isVisible]);

  const loadMonitoringData = async () => {
    try {
      // è·å–æ€§èƒ½æŒ‡æ ‡
      const metricsData = await window.electron?.ipcRenderer.invoke('monitoring:getMetrics');
      setMetrics(metricsData || []);

      // è·å–ç³»ç»Ÿä¿¡æ¯
      const systemData = await window.electron?.ipcRenderer.invoke('monitoring:getSystemInfo');
      setSystemInfo(systemData);

      // è·å–é”™è¯¯æ—¥å¿—
      const errorsData = await window.electron?.ipcRenderer.invoke('monitoring:getErrors');
      setErrors(errorsData || []);
    } catch (error) {
      console.error('åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥:', error);
    }
  };

  const memoryChartData = {
    labels: metrics.map(m => new Date(m.timestamp).toLocaleTimeString()),
    datasets: [
      {
        label: 'å †å†…å­˜ä½¿ç”¨ (MB)',
        data: metrics.map(m => m.memory.heapUsed / 1024 / 1024),
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1,
      },
      {
        label: 'æ€»å†…å­˜ (MB)',
        data: metrics.map(m => m.memory.heapTotal / 1024 / 1024),
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        tension: 0.1,
      },
    ],
  };

  const cpuChartData = {
    labels: metrics.map(m => new Date(m.timestamp).toLocaleTimeString()),
    datasets: [
      {
        label: 'CPU ä½¿ç”¨ç‡ (%)',
        data: metrics.map(m => m.cpu.usage),
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        tension: 0.1,
      },
    ],
  };

  const errorTypeData = {
    labels: ['JavaScripté”™è¯¯', 'ç½‘ç»œé”™è¯¯', 'ç³»ç»Ÿé”™è¯¯', 'å…¶ä»–'],
    datasets: [
      {
        data: [
          errors.filter(e => e.type === 'javascript').length,
          errors.filter(e => e.type === 'network').length,
          errors.filter(e => e.type === 'system').length,
          errors.filter(e => !['javascript', 'network', 'system'].includes(e.type)).length,
        ],
        backgroundColor: [
          'rgba(255, 99, 132, 0.8)',
          'rgba(54, 162, 235, 0.8)',
          'rgba(255, 205, 86, 0.8)',
          'rgba(75, 192, 192, 0.8)',
        ],
      },
    ],
  };

  if (!isVisible) return null;

  return (
    <div className="monitoring-dashboard">
      <div className="dashboard-header">
        <h2>ç³»ç»Ÿç›‘æ§é¢æ¿</h2>
        <button onClick={onClose} className="close-btn">Ã—</button>
      </div>

      <div className="dashboard-content">
        {/* ç³»ç»Ÿæ¦‚è§ˆ */}
        <div className="overview-section">
          <div className="metric-card">
            <h3>åº”ç”¨ä¿¡æ¯</h3>
            <div className="metric-value">
              <span>ç‰ˆæœ¬: {systemInfo?.version}</span>
              <span>è¿è¡Œæ—¶é—´: {Math.floor((systemInfo?.uptime || 0) / 60)} åˆ†é’Ÿ</span>
              <span>å¹³å°: {systemInfo?.platform}</span>
            </div>
          </div>

          <div className="metric-card">
            <h3>å†…å­˜ä½¿ç”¨</h3>
            <div className="metric-value">
              {metrics.length > 0 && (
                <>
                  <span>å½“å‰: {(metrics[metrics.length - 1].memory.heapUsed / 1024 / 1024).toFixed(2)} MB</span>
                  <span>å³°å€¼: {Math.max(...metrics.map(m => m.memory.heapUsed / 1024 / 1024)).toFixed(2)} MB</span>
                </>
              )}
            </div>
          </div>

          <div className="metric-card">
            <h3>é”™è¯¯ç»Ÿè®¡</h3>
            <div className="metric-value">
              <span>æ€»é”™è¯¯: {errors.length}</span>
              <span>æœ€è¿‘1å°æ—¶: {errors.filter(e => Date.now() - e.timestamp < 3600000).length}</span>
            </div>
          </div>
        </div>

        {/* å›¾è¡¨åŒºåŸŸ */}
        <div className="charts-section">
          <div className="chart-container">
            <h3>å†…å­˜ä½¿ç”¨è¶‹åŠ¿</h3>
            <Line data={memoryChartData} options={{
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'å†…å­˜ (MB)'
                  }
                }
              }
            }} />
          </div>

          <div className="chart-container">
            <h3>CPU ä½¿ç”¨è¶‹åŠ¿</h3>
            <Line data={cpuChartData} options={{
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'CPU (%)'
                  }
                }
              }
            }} />
          </div>

          <div className="chart-container">
            <h3>é”™è¯¯ç±»å‹åˆ†å¸ƒ</h3>
            <Doughnut data={errorTypeData} options={{
              responsive: true,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }} />
          </div>
        </div>

        {/* é”™è¯¯æ—¥å¿— */}
        <div className="errors-section">
          <h3>æœ€è¿‘é”™è¯¯</h3>
          <div className="error-list">
            {errors.slice(-10).reverse().map((error, index) => (
              <div key={index} className="error-item">
                <div className="error-time">
                  {new Date(error.timestamp).toLocaleString()}
                </div>
                <div className="error-message">{error.message}</div>
                <div className="error-type">{error.type}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

export default MonitoringDashboard;
```

### 7.2 ç›‘æ§é¢æ¿æ ·å¼

```css
/* ç›‘æ§é¢æ¿æ ·å¼ */
.monitoring-dashboard {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 1000;
  overflow-y: auto;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.dashboard-header h2 {
  color: #f3f4f6;
  margin: 0;
}

.dashboard-content {
  padding: 20px;
}

.overview-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.metric-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.metric-card h3 {
  color: #f3f4f6;
  margin: 0 0 15px 0;
  font-size: 16px;
}

.metric-value {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.metric-value span {
  color: #d1d5db;
  font-size: 14px;
}

.charts-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-bottom: 30px;
}

.chart-container {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.chart-container h3 {
  color: #f3f4f6;
  margin: 0 0 20px 0;
  font-size: 16px;
}

.errors-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.errors-section h3 {
  color: #f3f4f6;
  margin: 0 0 20px 0;
  font-size: 16px;
}

.error-list {
  max-height: 300px;
  overflow-y: auto;
}

.error-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  gap: 15px;
}

.error-item:last-child {
  border-bottom: none;
}

.error-time {
  color: #9ca3af;
  font-size: 12px;
  white-space: nowrap;
}

.error-message {
  color: #f3f4f6;
  font-size: 14px;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.error-type {
  background: rgba(239, 68, 68, 0.2);
  color: #fca5a5;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
}
```

## 8. æ€»ç»“

æœ¬æ¡Œé¢ç«¯éƒ¨ç½²è¿ç»´æ–¹æ¡ˆæ–‡æ¡£è¯¦ç»†æè¿°äº† OfferHelper æ¡Œé¢ç«¯åº”ç”¨çš„å®Œæ•´éƒ¨ç½²å’Œè¿ç»´ä½“ç³»ï¼ŒåŒ…æ‹¬ï¼š

### 8.1 éƒ¨ç½²ç‰¹è‰²

- **è‡ªåŠ¨åŒ–æ„å»º**: å®Œæ•´çš„ CI/CD æµæ°´çº¿ï¼Œæ”¯æŒå¤šå¹³å°è‡ªåŠ¨æ„å»º
- **ä»£ç ç­¾å**: æ”¯æŒ macOS å’Œ Windows å¹³å°çš„ä»£ç ç­¾åå’Œå…¬è¯
- **å®‰å…¨æ£€æŸ¥**: é›†æˆå®‰å…¨æ‰«æå’Œæ¼æ´æ£€æµ‹
- **å¤šæ¸ é“åˆ†å‘**: æ”¯æŒå®˜ç½‘ã€åº”ç”¨å•†åº—ã€åŒ…ç®¡ç†å™¨ç­‰å¤šç§åˆ†å‘æ–¹å¼

### 8.2 è¿ç»´ä¼˜åŠ¿

- **å®æ—¶ç›‘æ§**: å®Œæ•´çš„æ€§èƒ½ç›‘æ§å’Œé”™è¯¯è¿½è¸ªç³»ç»Ÿ
- **è‡ªåŠ¨æ›´æ–°**: æ™ºèƒ½çš„å¢é‡æ›´æ–°æœºåˆ¶
- **ä½¿ç”¨ç»Ÿè®¡**: è¯¦ç»†çš„ç”¨æˆ·è¡Œä¸ºåˆ†æ
- **æ•…éšœè¯Šæ–­**: å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜çš„å·¥å…·é“¾

### 8.3 æŠ€æœ¯äº®ç‚¹

- **è·¨å¹³å°æ”¯æŒ**: Windowsã€macOSã€Linux ä¸‰å¤§å¹³å°
- **å®‰å…¨å¯é **: å¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤å’Œæ•°æ®ä¿æŠ¤
- **æ€§èƒ½ä¼˜åŒ–**: å†…å­˜å’Œ CPU ä½¿ç”¨ç›‘æ§ä¸ä¼˜åŒ–
- **ç”¨æˆ·ä½“éªŒ**: æ— æ„ŸçŸ¥çš„æ›´æ–°å’Œé”™è¯¯æ¢å¤æœºåˆ¶

### 8.4 è¿ç»´æµç¨‹

1. **å¼€å‘é˜¶æ®µ**: ä»£ç è´¨é‡æ£€æŸ¥ã€å®‰å…¨æ‰«æã€å•å…ƒæµ‹è¯•
2. **æ„å»ºé˜¶æ®µ**: è‡ªåŠ¨åŒ–æ„å»ºã€ä»£ç ç­¾åã€åˆ¶å“ç”Ÿæˆ
3. **æµ‹è¯•é˜¶æ®µ**: E2E æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€å…¼å®¹æ€§æµ‹è¯•
4. **å‘å¸ƒé˜¶æ®µ**: å¤šæ¸ é“åˆ†å‘ã€ç‰ˆæœ¬ç®¡ç†ã€å›æ»šæœºåˆ¶
5. **è¿ç»´é˜¶æ®µ**: ç›‘æ§å‘Šè­¦ã€æ€§èƒ½åˆ†æã€ç”¨æˆ·åé¦ˆ

è¯¥éƒ¨ç½²è¿ç»´æ–¹æ¡ˆç¡®ä¿äº†æ¡Œé¢ç«¯åº”ç”¨èƒ½å¤Ÿç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆåœ°ä¸ºç”¨æˆ·æä¾›æœåŠ¡ï¼ŒåŒæ—¶ä¸ºå¼€å‘å›¢é˜Ÿæä¾›äº†å®Œæ•´çš„è¿ç»´å·¥å…·é“¾å’Œç›‘æ§ä½“ç³»ã€‚

## 9. é™„å½•

### 9.1 å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev                    # å¯åŠ¨å¼€å‘ç¯å¢ƒ
npm run build                  # æ„å»ºåº”ç”¨
npm run test                   # è¿è¡Œæµ‹è¯•
npm run lint                   # ä»£ç æ£€æŸ¥

# æ„å»ºåˆ†å‘
npm run dist                   # æ„å»ºæ‰€æœ‰å¹³å°
npm run dist:mac              # æ„å»º macOS ç‰ˆæœ¬
npm run dist:win              # æ„å»º Windows ç‰ˆæœ¬
npm run dist:linux            # æ„å»º Linux ç‰ˆæœ¬

# ç»´æŠ¤å·¥å…·
npm run clean                  # æ¸…ç†æ„å»ºæ–‡ä»¶
npm run rebuild               # é‡æ–°æ„å»º
npm run security-check        # å®‰å…¨æ£€æŸ¥
npm run performance-test      # æ€§èƒ½æµ‹è¯•
```

### 9.2 ç¯å¢ƒå˜é‡é…ç½®

```bash
# æ„å»ºç¯å¢ƒå˜é‡
NODE_ENV=production           # ç¯å¢ƒç±»å‹
ELECTRON_BUILDER_CACHE_DIR    # æ„å»ºç¼“å­˜ç›®å½•

# ä»£ç ç­¾å
CSC_LINK                      # macOS è¯ä¹¦è·¯å¾„
CSC_KEY_PASSWORD             # macOS è¯ä¹¦å¯†ç 
WIN_CSC_LINK                 # Windows è¯ä¹¦è·¯å¾„
WIN_CSC_KEY_PASSWORD         # Windows è¯ä¹¦å¯†ç 

# å‘å¸ƒé…ç½®
GH_TOKEN                     # GitHub Token
SENTRY_DSN                   # Sentry DSN
ANALYTICS_KEY                # åˆ†ææœåŠ¡å¯†é’¥

# æ›´æ–°æœåŠ¡
UPDATE_SERVER_URL            # æ›´æ–°æœåŠ¡å™¨åœ°å€
AUTO_UPDATE_ENABLED          # æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ›´æ–°
```

### 9.3 æ•…éšœæ’æŸ¥æŒ‡å—

#### 9.3.1 æ„å»ºå¤±è´¥

```bash
# æ¸…ç†ç¼“å­˜é‡æ–°æ„å»º
npm run clean
rm -rf node_modules
npm install
npm run build

# æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
npm audit
npm outdated

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
npm run build -- --verbose
```

#### 9.3.2 ç­¾åå¤±è´¥

```bash
# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§
security find-identity -v -p codesigning  # macOS
certlm.msc                                 # Windows

# éªŒè¯è¯ä¹¦é…ç½®
echo $CSC_LINK
echo $CSC_KEY_PASSWORD

# æ‰‹åŠ¨ç­¾åæµ‹è¯•
codesign --verify --verbose dist/mac/OfferHelper.app  # macOS
```

#### 9.3.3 æ›´æ–°å¤±è´¥

```bash
# æ£€æŸ¥æ›´æ–°æœåŠ¡å™¨è¿æ¥
curl -I https://api.offerhelper.com/updates

# æŸ¥çœ‹æ›´æ–°æ—¥å¿—
tail -f ~/Library/Logs/OfferHelper/main.log  # macOS
type %APPDATA%\OfferHelper\logs\main.log     # Windows

# æ‰‹åŠ¨è§¦å‘æ›´æ–°æ£€æŸ¥
# åœ¨åº”ç”¨ä¸­æŒ‰ Ctrl+Shift+U
```

### 9.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 9.4.1 å†…å­˜ä¼˜åŒ–

- å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„å¯¹è±¡å¼•ç”¨
- ä½¿ç”¨ WeakMap å’Œ WeakSet é¿å…å†…å­˜æ³„æ¼
- é™åˆ¶åŒæ—¶å¤„ç†çš„æ•°æ®é‡
- å®ç°å¯¹è±¡æ± å¤ç”¨æœºåˆ¶

#### 9.4.2 å¯åŠ¨ä¼˜åŒ–

- å»¶è¿ŸåŠ è½½éå…³é”®æ¨¡å—
- ä½¿ç”¨é¢„ç¼–è¯‘çš„æ¨¡æ¿å’Œèµ„æº
- ä¼˜åŒ–ä¸»è¿›ç¨‹åˆå§‹åŒ–æµç¨‹
- å‡å°‘åŒæ­¥ I/O æ“ä½œ

#### 9.4.3 æ¸²æŸ“ä¼˜åŒ–

- ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§åˆ—è¡¨
- å®ç°ç»„ä»¶æ‡’åŠ è½½
- ä¼˜åŒ– CSS é€‰æ‹©å™¨æ€§èƒ½
- å‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“

### 9.5 å®‰å…¨æœ€ä½³å®è·µ

#### 9.5.1 ä»£ç å®‰å…¨

- å®šæœŸæ›´æ–°ä¾èµ–åŒ…ç‰ˆæœ¬
- ä½¿ç”¨ ESLint å®‰å…¨è§„åˆ™
- é¿å…ä½¿ç”¨ eval() å’Œ innerHTML
- éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥

#### 9.5.2 æ•°æ®å®‰å…¨

- åŠ å¯†æ•æ„Ÿæ•°æ®å­˜å‚¨
- ä½¿ç”¨ HTTPS è¿›è¡Œç½‘ç»œé€šä¿¡
- å®ç°è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†
- å®šæœŸå¤‡ä»½é‡è¦æ•°æ®

#### 9.5.3 è¿è¡Œæ—¶å®‰å…¨

- å¯ç”¨å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)
- ç¦ç”¨ä¸å¿…è¦çš„ Node.js é›†æˆ
- ä½¿ç”¨æ²™ç®±æ¨¡å¼è¿è¡Œæ¸²æŸ“è¿›ç¨‹
- å®šæœŸæ£€æŸ¥å’Œæ›´æ–°å®‰å…¨é…ç½®

è¯¥éƒ¨ç½²è¿ç»´æ–¹æ¡ˆä¸º OfferHelper æ¡Œé¢ç«¯åº”ç”¨æä¾›äº†å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒæ”¯æŒï¼Œç¡®ä¿åº”ç”¨èƒ½å¤Ÿç¨³å®šã€å®‰å…¨ã€é«˜æ•ˆåœ°ä¸ºç”¨æˆ·æä¾›æœåŠ¡ã€‚

# æ¡Œé¢ç«¯éƒ¨ç½²è¿ç»´æ–¹æ¡ˆ

## 1. éƒ¨ç½²æ¶æ„æ¦‚è§ˆ

### 1.1 éƒ¨ç½²æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å‘ç¯å¢ƒ       â”‚    â”‚   æ„å»ºç¯å¢ƒ       â”‚    â”‚   åˆ†å‘ç¯å¢ƒ       â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â€¢ ä»£ç å¼€å‘      â”‚â”€â”€â”€â–¶â”‚ â€¢ è‡ªåŠ¨æ„å»º      â”‚â”€â”€â”€â–¶â”‚ â€¢ åº”ç”¨ç­¾å      â”‚
â”‚ â€¢ æœ¬åœ°æµ‹è¯•      â”‚    â”‚ â€¢ è´¨é‡æ£€æŸ¥      â”‚    â”‚ â€¢ ç‰ˆæœ¬å‘å¸ƒ      â”‚
â”‚ â€¢ ä»£ç æäº¤      â”‚    â”‚ â€¢ å®‰å…¨æ‰«æ      â”‚    â”‚ â€¢ æ›´æ–°æ¨é€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰ˆæœ¬æ§åˆ¶       â”‚    â”‚   CI/CD æµæ°´çº¿   â”‚    â”‚   ç”¨æˆ·è®¾å¤‡       â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â€¢ Git ä»“åº“      â”‚    â”‚ â€¢ GitHub Actionsâ”‚    â”‚ â€¢ è‡ªåŠ¨æ›´æ–°      â”‚
â”‚ â€¢ åˆ†æ”¯ç®¡ç†      â”‚    â”‚ â€¢ æ„å»ºç¼“å­˜      â”‚    â”‚ â€¢ é”™è¯¯ä¸ŠæŠ¥      â”‚
â”‚ â€¢ ä»£ç å®¡æŸ¥      â”‚    â”‚ â€¢ æµ‹è¯•è¦†ç›–      â”‚    â”‚ â€¢ ä½¿ç”¨ç»Ÿè®¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

```json
{
  "æ„å»ºå·¥å…·": {
    "ä¸»æ„å»º": "Electron Builder",
    "æ‰“åŒ…": "Webpack 5",
    "ä»£ç å‹ç¼©": "Terser",
    "èµ„æºä¼˜åŒ–": "ImageMin"
  },
  "CI/CD": {
    "å¹³å°": "GitHub Actions",
    "ç¼“å­˜": "GitHub Cache",
    "åˆ¶å“å­˜å‚¨": "GitHub Releases",
    "é€šçŸ¥": "Slack/é’‰é’‰"
  },
  "åˆ†å‘æ¸ é“": {
    "å®˜æ–¹ç½‘ç«™": "ç›´æ¥ä¸‹è½½",
    "åº”ç”¨å•†åº—": "Microsoft Store, Mac App Store",
    "åŒ…ç®¡ç†å™¨": "Homebrew, Chocolatey, Snap",
    "ä¼ä¸šåˆ†å‘": "å†…éƒ¨æ›´æ–°æœåŠ¡å™¨"
  },
  "ç›‘æ§è¿ç»´": {
    "é”™è¯¯ç›‘æ§": "Sentry",
    "æ€§èƒ½ç›‘æ§": "Electron APM",
    "ä½¿ç”¨ç»Ÿè®¡": "Google Analytics",
    "æ—¥å¿—æ”¶é›†": "Winston + LogRocket"
  }
}
```

## 2. æ„å»ºé…ç½®

### 2.1 Electron Builder é…ç½®

```json
{
  "name": "offerhelper",
  "productName": "OfferHelper",
  "version": "1.0.0",
  "description": "ç¨‹åºå‘˜é¢è¯•AIè¾…åŠ©åŠ©æ‰‹",
  "main": "dist/main.js",
  "homepage": "https://offerhelper.com",
  "author": {
    "name": "OfferHelper Team",
    "email": "support@offerhelper.com"
  },
  "build": {
    "appId": "com.offerhelper.desktop",
    "productName": "OfferHelper",
    "copyright": "Copyright Â© 2024 OfferHelper Team",
    "directories": {
      "output": "release",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "extraResources": [
      {
        "from": "resources/",
        "to": "resources/",
        "filter": ["**/*"]
      }
    ],
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "build/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        },
        {
          "target": "zip",
          "arch": ["x64", "arm64"]
        }
      ]
    },
    "win": {
      "icon": "build/icon.ico",
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x64"]
        }
      ]
    },
    "linux": {
      "icon": "build/icon.png",
      "target": [
        {
          "target": "AppImage",
          "arch": ["x64"]
        },
        {
          "target": "deb",
          "arch": ["x64"]
        },
        {
          "target": "rpm",
          "arch": ["x64"]
        }
      ]
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "installerIcon": "build/icon.ico",
      "uninstallerIcon": "build/icon.ico",
      "installerHeaderIcon": "build/icon.ico",
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "OfferHelper"
    },
    "dmg": {
      "title": "OfferHelper ${version}",
      "icon": "build/icon.icns",
      "background": "build/dmg-background.png",
      "contents": [
        {
          "x": 130,
          "y": 220,
          "type": "file"
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ]
    },
    "publish": [
      {
        "provider": "github",
        "owner": "offerhelper",
        "repo": "desktop"
      }
    ]
  }
}
```

### 2.2 æ„å»ºè„šæœ¬

```json
{
  "scripts": {
    "dev": "concurrently \"npm run dev:main\" \"npm run dev:renderer\"",
    "dev:main": "webpack --config webpack.main.config.js --mode development --watch",
    "dev:renderer": "webpack serve --config webpack.renderer.config.js --mode development",
    "build": "npm run build:main && npm run build:renderer",
    "build:main": "webpack --config webpack.main.config.js --mode production",
    "build:renderer": "webpack --config webpack.renderer.config.js --mode production",
    "dist": "npm run build && electron-builder",
    "dist:mac": "npm run build && electron-builder --mac",
    "dist:win": "npm run build && electron-builder --win",
    "dist:linux": "npm run build && electron-builder --linux",
    "pack": "npm run build && electron-builder --dir",
    "postinstall": "electron-builder install-app-deps",
    "test": "jest",
    "test:e2e": "playwright test",
    "lint": "eslint src --ext .ts,.tsx",
    "lint:fix": "eslint src --ext .ts,.tsx --fix",
    "type-check": "tsc --noEmit",
    "clean": "rimraf dist release",
    "rebuild": "npm run clean && npm install && npm run build"
  }
}
```

### 2.3 Webpack é…ç½®

```javascript
// webpack.main.config.js
const path = require('path');

module.exports = {
  target: 'electron-main',
  entry: './src/main/main.ts',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'main.js'
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader',
        exclude: /node_modules/
      }
    ]
  },
  resolve: {
    extensions: ['.ts', '.js']
  },
  node: {
    __dirname: false,
    __filename: false
  },
  externals: {
    'better-sqlite3': 'commonjs better-sqlite3',
    'ffi-napi': 'commonjs ffi-napi'
  }
};

// webpack.renderer.config.js
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

module.exports = (env, argv) => {
  const isProduction = argv.mode === 'production';

  return {
    target: 'electron-renderer',
    entry: './src/renderer/index.tsx',
    output: {
      path: path.resolve(__dirname, 'dist'),
      filename: 'renderer.js'
    },
    module: {
      rules: [
        {
          test: /\.tsx?$/,
          use: 'ts-loader',
          exclude: /node_modules/
        },
        {
          test: /\.css$/,
          use: [
            isProduction ? MiniCssExtractPlugin.loader : 'style-loader',
            'css-loader',
            'postcss-loader'
          ]
        },
        {
          test: /\.(png|jpg|gif|svg)$/,
          type: 'asset/resource'
        }
      ]
    },
    resolve: {
      extensions: ['.tsx', '.ts', '.js'],
      alias: {
        '@': path.resolve(__dirname, 'src/renderer')
      }
    },
    plugins: [
      new HtmlWebpackPlugin({
        template: './src/renderer/index.html'
      }),
      ...(isProduction ? [new MiniCssExtractPlugin()] : [])
    ],
    devServer: {
      port: 3000,
      hot: true
    }
  };
};
```

## 3. CI/CD æµæ°´çº¿

### 3.1 GitHub Actions é…ç½®

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm test

      - name: Run E2E tests
        run: npm run test:e2e

  build:
    needs: test
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build distributables
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-${{ matrix.os }}
          path: release/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-macos-latest/**/*
            dist-windows-latest/**/*
            dist-ubuntu-latest/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 3.2 ä»£ç è´¨é‡æ£€æŸ¥

```yaml
# .github/workflows/quality.yml
name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format=json --output-file=eslint-report.json
        continue-on-error: true

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,css,md}"

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run dependency check
        run: npx depcheck

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

### 3.3 è‡ªåŠ¨åŒ–æµ‹è¯•

```yaml
# .github/workflows/test.yml
name: Automated Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --coverage --watchAll=false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  e2e-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Install Playwright
        run: npx playwright install

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report-${{ matrix.os }}
          path: playwright-report/
```

## 4. ä»£ç ç­¾åä¸å®‰å…¨

### 4.1 macOS ä»£ç ç­¾å

```xml
<!-- build/entitlements.mac.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>com.apple.security.cs.allow-jit</key>
  <true/>
  <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
  <true/>
  <key>com.apple.security.cs.disable-library-validation</key>
  <true/>
  <key>com.apple.security.device.microphone</key>
  <true/>
  <key>com.apple.security.device.camera</key>
  <false/>
  <key>com.apple.security.network.client</key>
  <true/>
  <key>com.apple.security.network.server</key>
  <false/>
  <key>com.apple.security.files.user-selected.read-write</key>
  <true/>
</dict>
</plist>
```

```bash
# ç­¾åè„šæœ¬
#!/bin/bash

# è®¾ç½®ç¯å¢ƒå˜é‡
export CSC_LINK="path/to/certificate.p12"
export CSC_KEY_PASSWORD="certificate_password"
export APPLE_ID="developer@example.com"
export APPLE_ID_PASSWORD="app_specific_password"

# æ„å»ºå¹¶ç­¾å
npm run dist:mac

# å…¬è¯åº”ç”¨
xcrun altool --notarize-app \
  --primary-bundle-id "com.offerhelper.desktop" \
  --username "$APPLE_ID" \
  --password "$APPLE_ID_PASSWORD" \
  --file "release/OfferHelper-1.0.0.dmg"
```

### 4.2 Windows ä»£ç ç­¾å

```javascript
// ç­¾åé…ç½®
const { execSync } = require('child_process');
const path = require('path');

function signWindows() {
  const signtool = 'C:\\Program Files (x86)\\Windows Kits\\10\\bin\\10.0.19041.0\\x64\\signtool.exe';
  const certificate = process.env.WIN_CSC_LINK;
  const password = process.env.WIN_CSC_KEY_PASSWORD;

  const files = [
    'release/OfferHelper Setup 1.0.0.exe',
    'release/OfferHelper 1.0.0.exe'
  ];

  files.forEach(file => {
    if (require('fs').existsSync(file)) {
      const command = `"${signtool}" sign /f "${certificate}" /p "${password}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "${file}"`;
      execSync(command, { stdio: 'inherit' });
      console.log(`å·²ç­¾å: ${file}`);
    }
  });
}

module.exports = { signWindows };
```

### 4.3 å®‰å…¨æ£€æŸ¥è„šæœ¬

```javascript
// scripts/security-check.js
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

class SecurityChecker {
  constructor() {
    this.vulnerabilities = [];
    this.securityRules = [
      this.checkHardcodedSecrets,
      this.checkInsecureProtocols,
      this.checkDangerousPermissions,
      this.checkOutdatedDependencies
    ];
  }

  async runAllChecks() {
    console.log('ğŸ” å¼€å§‹å®‰å…¨æ£€æŸ¥...');

    for (const rule of this.securityRules) {
      await rule.call(this);
    }

    this.generateReport();
  }

  checkHardcodedSecrets() {
    const patterns = [
      /api[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /secret[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /password\s*[:=]\s*['"][^'"]+['"]/gi,
      /token\s*[:=]\s*['"][^'"]+['"]/gi
    ];

    this.scanFiles('src', patterns, 'ç¡¬ç¼–ç å¯†é’¥');
  }

  checkInsecureProtocols() {
    const patterns = [
      /http:\/\/(?!localhost|127\.0\.0\.1)/gi,
      /ftp:\/\//gi
    ];

    this.scanFiles('src', patterns, 'ä¸å®‰å…¨åè®®');
  }

  checkDangerousPermissions() {
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const dangerousPerms = [
      'nodeIntegration: true',
      'contextIsolation: false',
      'webSecurity: false'
    ];

    // æ£€æŸ¥æ˜¯å¦æœ‰å±é™©çš„ Electron é…ç½®
    this.scanFiles('src', dangerousPerms.map(p => new RegExp(p, 'gi')), 'å±é™©æƒé™');
  }

  async checkOutdatedDependencies() {
    try {
      const { execSync } = require('child_process');
      const auditResult = execSync('npm audit --json', { encoding: 'utf8' });
      const audit = JSON.parse(auditResult);

      if (audit.metadata.vulnerabilities.total > 0) {
        this.vulnerabilities.push({
          type: 'ä¾èµ–æ¼æ´',
          count: audit.metadata.vulnerabilities.total,
          details: audit.advisories
        });
      }
    } catch (error) {
      console.warn('ä¾èµ–æ£€æŸ¥å¤±è´¥:', error.message);
    }
  }

  scanFiles(dir, patterns, type) {
    const files = this.getAllFiles(dir);

    files.forEach(file => {
      const content = fs.readFileSync(file, 'utf8');

      patterns.forEach(pattern => {
        const matches = content.match(pattern);
        if (matches) {
          this.vulnerabilities.push({
            type,
            file,
            matches: matches.length,
            details: matches
          });
        }
      });
    });
  }

  getAllFiles(dir) {
    let files = [];
    const items = fs.readdirSync(dir);

    items.forEach(item => {
      const fullPath = path.join(dir, item);
      const stat = fs.statSync(fullPath);

      if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
        files = files.concat(this.getAllFiles(fullPath));
      } else if (stat.isFile() && /\.(js|ts|tsx|jsx)$/.test(item)) {
        files.push(fullPath);
      }
    });

    return files;
  }

  generateReport() {
    console.log('\nğŸ“Š å®‰å…¨æ£€æŸ¥æŠ¥å‘Š');
    console.log('='.repeat(50));

    if (this.vulnerabilities.length === 0) {
      console.log('âœ… æœªå‘ç°å®‰å…¨é—®é¢˜');
      return;
    }

    this.vulnerabilities.forEach((vuln, index) => {
      console.log(`\n${index + 1}. ${vuln.type}`);
      if (vuln.file) {
        console.log(`   æ–‡ä»¶: ${vuln.file}`);
        console.log(`   åŒ¹é…: ${vuln.matches} ä¸ª`);
      }
      if (vuln.count) {
        console.log(`   æ•°é‡: ${vuln.count}`);
      }
    });

    console.log(`\nâš ï¸  æ€»è®¡å‘ç° ${this.vulnerabilities.length} ä¸ªå®‰å…¨é—®é¢˜`);

    // å¦‚æœæœ‰é«˜å±æ¼æ´ï¼Œé€€å‡ºæ„å»º
    const criticalIssues = this.vulnerabilities.filter(v =>
      v.type === 'ç¡¬ç¼–ç å¯†é’¥' || v.type === 'å±é™©æƒé™'
    );

    if (criticalIssues.length > 0) {
      console.error('âŒ å‘ç°é«˜å±å®‰å…¨é—®é¢˜ï¼Œæ„å»ºç»ˆæ­¢');
      process.exit(1);
    }
  }
}

// è¿è¡Œå®‰å…¨æ£€æŸ¥
if (require.main === module) {
  const checker = new SecurityChecker();
  checker.runAllChecks();
}

module.exports = SecurityChecker;
```

## 5. è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ

### 5.1 æ›´æ–°æœåŠ¡å™¨é…ç½®

```javascript
// update-server/server.js
const express = require('express');
const semver = require('semver');
const app = express();

// ç‰ˆæœ¬ä¿¡æ¯å­˜å‚¨
const versions = {
  'darwin': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-x64.zip',
      signature: 'signature_hash_here'
    },
    'arm64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-arm64.zip',
      signature: 'signature_hash_here'
    }
  },
  'win32': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-win-x64.exe',
      signature: 'signature_hash_here'
    }
  },
  'linux': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-linux-x64.AppImage',
      signature: 'signature_hash_here'
    }
  }
};

// æ£€æŸ¥æ›´æ–°æ¥å£
app.get('/update/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  const platformVersions = versions[platform];
  if (!platformVersions) {
    return res.status(404).json({ error: 'Platform not supported' });
  }

  const archVersion = platformVersions[arch];
  if (!archVersion) {
    return res.status(404).json({ error: 'Architecture not supported' });
  }

  // æ¯”è¾ƒç‰ˆæœ¬
  if (semver.gt(archVersion.version, version)) {
    res.json({
      version: archVersion.version,
      url: archVersion.url,
      signature: archVersion.signature,
      releaseNotes: `æ›´æ–°åˆ°ç‰ˆæœ¬ ${archVersion.version}`
    });
  } else {
    res.status(204).send(); // æ— æ›´æ–°
  }
});

// ä¸‹è½½ç»Ÿè®¡
app.get('/download/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  // è®°å½•ä¸‹è½½ç»Ÿè®¡
  console.log(`ä¸‹è½½: ${platform}-${arch}-${version}`);

  // é‡å®šå‘åˆ°å®é™…ä¸‹è½½åœ°å€
  const platformVersions = versions[platform];
  const archVersion = platformVersions?.[arch];

  if (archVersion && archVersion.version === version) {
    res.redirect(archVersion.url);
  } else {
    res.status(404).json({ error: 'Version not found' });
  }
});

app.listen(3001, () => {
  console.log('æ›´æ–°æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 3001');
});
```

### 5.2 å®¢æˆ·ç«¯æ›´æ–°é€»è¾‘

```typescript
// src/main/updater.ts
import { autoUpdater } from 'electron-updater';
import { dialog, BrowserWindow } from 'electron';
import log from 'electron-log';

class AppUpdater {
  private mainWindow: BrowserWindow;
  private updateCheckInterval: NodeJS.Timeout | null = null;

  constructor(mainWindow: BrowserWindow) {
    this.mainWindow = mainWindow;
    this.setupUpdater();
  }

  private setupUpdater(): void {
    // é…ç½®æ›´æ–°æœåŠ¡å™¨
    autoUpdater.setFeedURL({
      provider: 'generic',
      url: 'https://api.offerhelper.com/updates'
    });

    // é…ç½®æ—¥å¿—
    autoUpdater.logger = log;
    (autoUpdater.logger as any).transports.file.level = 'info';

    // äº‹ä»¶ç›‘å¬
    autoUpdater.on('checking-for-update', () => {
      log.info('æ£€æŸ¥æ›´æ–°ä¸­...');
      this.sendStatusToWindow('checking-for-update');
    });

    autoUpdater.on('update-available', (info) => {
      log.info('å‘ç°æ–°ç‰ˆæœ¬:', info.version);
      this.sendStatusToWindow('update-available', info);
      this.showUpdateDialog(info);
    });

    autoUpdater.on('update-not-available', (info) => {
      log.info('å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
      this.sendStatusToWindow('update-not-available', info);
    });

    autoUpdater.on('error', (err) => {
      log.error('æ›´æ–°é”™è¯¯:', err);
      this.sendStatusToWindow('update-error', err);
    });

    autoUpdater.on('download-progress', (progressObj) => {
      let logMessage = `ä¸‹è½½é€Ÿåº¦: ${progressObj.bytesPerSecond}`;
      logMessage += ` - å·²ä¸‹è½½ ${progressObj.percent}%`;
      logMessage += ` (${progressObj.transferred}/${progressObj.total})`;

      log.info(logMessage);
      this.sendStatusToWindow('download-progress', progressObj);
    });

    autoUpdater.on('update-downloaded', (info) => {
      log.info('æ›´æ–°ä¸‹è½½å®Œæˆ');
      this.sendStatusToWindow('update-downloaded', info);
      this.showRestartDialog();
    });
  }

  public checkForUpdates(): void {
    autoUpdater.checkForUpdatesAndNotify();
  }

  public startAutoCheck(): void {
    // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
    this.updateCheckInterval = setInterval(() => {
      this.checkForUpdates();
    }, 60 * 60 * 1000);

    // å¯åŠ¨æ—¶æ£€æŸ¥
    setTimeout(() => {
      this.checkForUpdates();
    }, 5000);
  }

  public stopAutoCheck(): void {
    if (this.updateCheckInterval) {
      clearInterval(this.updateCheckInterval);
      this.updateCheckInterval = null;
    }
  }

  private sendStatusToWindow(event: string, data?: any): void {
    if (this.mainWindow && !this.mainWindow.isDestroyed()) {
      this.mainWindow.webContents.send('updater-message', { event, data });
    }
  }

  private showUpdateDialog(info: any): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['ç«‹å³æ›´æ–°', 'ç¨åæé†’', 'è·³è¿‡æ­¤ç‰ˆæœ¬'],
      defaultId: 0,
      title: 'å‘ç°æ–°ç‰ˆæœ¬',
      message: `å‘ç°æ–°ç‰ˆæœ¬ ${info.version}`,
      detail: 'æ˜¯å¦ç«‹å³ä¸‹è½½å¹¶å®‰è£…æ›´æ–°ï¼Ÿ'
    });

    switch (response) {
      case 0: // ç«‹å³æ›´æ–°
        autoUpdater.downloadUpdate();
        break;
      case 1: // ç¨åæé†’
        // 1å°æ—¶åå†æ¬¡æé†’
        setTimeout(() => {
          this.showUpdateDialog(info);
        }, 60 * 60 * 1000);
        break;
      case 2: // è·³è¿‡æ­¤ç‰ˆæœ¬
        // è®°å½•è·³è¿‡çš„ç‰ˆæœ¬
        this.skipVersion(info.version);
        break;
    }
  }

  private showRestartDialog(): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['ç«‹å³é‡å¯', 'ç¨åé‡å¯'],
      defaultId: 0,
      title: 'æ›´æ–°å·²ä¸‹è½½',
      message: 'æ›´æ–°å·²ä¸‹è½½å®Œæˆ',
      detail: 'éœ€è¦é‡å¯åº”ç”¨ä»¥å®Œæˆæ›´æ–°ã€‚'
    });

    if (response === 0) {
      autoUpdater.quitAndInstall();
    }
  }

  private skipVersion(version: string): void {
    // å°†è·³è¿‡çš„ç‰ˆæœ¬ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    const { app } = require('electron');
    const fs = require('fs');
    const path = require('path');

    const configPath = path.join(app.getPath('userData'), 'update-config.json');
    let config = {};

    try {
      if (fs.existsSync(configPath)) {
        config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
      }
    } catch (error) {
      log.error('è¯»å–æ›´æ–°é…ç½®å¤±è´¥:', error);
    }

    config.skippedVersions = config.skippedVersions || [];
    if (!config.skippedVersions.includes(version)) {
      config.skippedVersions.push(version);
    }

    try {
      fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    } catch (error) {
      log.error('ä¿å­˜æ›´æ–°é…ç½®å¤±è´¥:', error);
    }
  }
}

export default AppUpdater;
```

### 5.3 æ¸²æŸ“è¿›ç¨‹æ›´æ–°ç•Œé¢

```tsx
// src/renderer/components/UpdateNotification.tsx
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface UpdateInfo {
  version: string;
  releaseNotes?: string;
}

interface UpdateProgress {
  percent: number;
  bytesPerSecond: number;
  transferred: number;
  total: number;
}

const UpdateNotification: React.FC = () => {
  const [updateState, setUpdateState] = useState<string>('');
  const [updateInfo, setUpdateInfo] = useState<UpdateInfo | null>(null);
  const [downloadProgress, setDownloadProgress] = useState<UpdateProgress | null>(null);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    // ç›‘å¬æ›´æ–°äº‹ä»¶
    const handleUpdaterMessage = (event: any, { event: updateEvent, data }: any) => {
      setUpdateState(updateEvent);

      switch (updateEvent) {
        case 'update-available':
          setUpdateInfo(data);
          setIsVisible(true);
          break;
        case 'download-progress':
          setDownloadProgress(data);
          break;
        case 'update-downloaded':
          setDownloadProgress(null);
          break;
        case 'update-not-available':
        case 'update-error':
          setTimeout(() => setIsVisible(false), 3000);
          break;
      }
    };

    window.electron?.ipcRenderer.on('updater-message', handleUpdaterMessage);

    return () => {
      window.electron?.ipcRenderer.removeListener('updater-message', handleUpdaterMessage);
    };
  }, []);

  const getStatusText = () => {
    switch (updateState) {
      case 'checking-for-update':
        return 'æ£€æŸ¥æ›´æ–°ä¸­...';
      case 'update-available':
        return `å‘ç°æ–°ç‰ˆæœ¬ ${updateInfo?.version}`;
# æ¡Œé¢ç«¯éƒ¨ç½²è¿ç»´æ–¹æ¡ˆ

## 1. éƒ¨ç½²æ¶æ„æ¦‚è§ˆ

### 1.1 éƒ¨ç½²æµç¨‹å›¾

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å‘ç¯å¢ƒ       â”‚    â”‚   æ„å»ºç¯å¢ƒ       â”‚    â”‚   åˆ†å‘ç¯å¢ƒ       â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â€¢ ä»£ç å¼€å‘      â”‚â”€â”€â”€â–¶â”‚ â€¢ è‡ªåŠ¨æ„å»º      â”‚â”€â”€â”€â–¶â”‚ â€¢ åº”ç”¨ç­¾å      â”‚
â”‚ â€¢ æœ¬åœ°æµ‹è¯•      â”‚    â”‚ â€¢ è´¨é‡æ£€æŸ¥      â”‚    â”‚ â€¢ ç‰ˆæœ¬å‘å¸ƒ      â”‚
â”‚ â€¢ ä»£ç æäº¤      â”‚    â”‚ â€¢ å®‰å…¨æ‰«æ      â”‚    â”‚ â€¢ æ›´æ–°æ¨é€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰ˆæœ¬æ§åˆ¶       â”‚    â”‚   CI/CD æµæ°´çº¿   â”‚    â”‚   ç”¨æˆ·è®¾å¤‡       â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â€¢ Git ä»“åº“      â”‚    â”‚ â€¢ GitHub Actionsâ”‚    â”‚ â€¢ è‡ªåŠ¨æ›´æ–°      â”‚
â”‚ â€¢ åˆ†æ”¯ç®¡ç†      â”‚    â”‚ â€¢ æ„å»ºç¼“å­˜      â”‚    â”‚ â€¢ é”™è¯¯ä¸ŠæŠ¥      â”‚
â”‚ â€¢ ä»£ç å®¡æŸ¥      â”‚    â”‚ â€¢ æµ‹è¯•è¦†ç›–      â”‚    â”‚ â€¢ ä½¿ç”¨ç»Ÿè®¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

```json
{
  "æ„å»ºå·¥å…·": {
    "ä¸»æ„å»º": "Electron Builder",
    "æ‰“åŒ…": "Webpack 5",
    "ä»£ç å‹ç¼©": "Terser",
    "èµ„æºä¼˜åŒ–": "ImageMin"
  },
  "CI/CD": {
    "å¹³å°": "GitHub Actions",
    "ç¼“å­˜": "GitHub Cache",
    "åˆ¶å“å­˜å‚¨": "GitHub Releases",
    "é€šçŸ¥": "Slack/é’‰é’‰"
  },
  "åˆ†å‘æ¸ é“": {
    "å®˜æ–¹ç½‘ç«™": "ç›´æ¥ä¸‹è½½",
    "åº”ç”¨å•†åº—": "Microsoft Store, Mac App Store",
    "åŒ…ç®¡ç†å™¨": "Homebrew, Chocolatey, Snap",
    "ä¼ä¸šåˆ†å‘": "å†…éƒ¨æ›´æ–°æœåŠ¡å™¨"
  },
  "ç›‘æ§è¿ç»´": {
    "é”™è¯¯ç›‘æ§": "Sentry",
    "æ€§èƒ½ç›‘æ§": "Electron APM",
    "ä½¿ç”¨ç»Ÿè®¡": "Google Analytics",
    "æ—¥å¿—æ”¶é›†": "Winston + LogRocket"
  }
}
```

## 2. æ„å»ºé…ç½®

### 2.1 Electron Builder é…ç½®

```json
{
  "name": "offerhelper",
  "productName": "OfferHelper",
  "version": "1.0.0",
  "description": "ç¨‹åºå‘˜é¢è¯•AIè¾…åŠ©åŠ©æ‰‹",
  "main": "dist/main.js",
  "homepage": "https://offerhelper.com",
  "author": {
    "name": "OfferHelper Team",
    "email": "support@offerhelper.com"
  },
  "build": {
    "appId": "com.offerhelper.desktop",
    "productName": "OfferHelper",
    "copyright": "Copyright Â© 2024 OfferHelper Team",
    "directories": {
      "output": "release",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "extraResources": [
      {
        "from": "resources/",
        "to": "resources/",
        "filter": ["**/*"]
      }
    ],
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "build/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        },
        {
          "target": "zip",
          "arch": ["x64", "arm64"]
        }
      ]
    },
    "win": {
      "icon": "build/icon.ico",
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x
