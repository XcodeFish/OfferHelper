# 桌面端部署运维方案

## 1. 部署架构概览

### 1.1 部署流程图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   开发环境       │    │   构建环境       │    │   分发环境       │
│                │    │                │    │                │
│ • 代码开发      │───▶│ • 自动构建      │───▶│ • 应用签名      │
│ • 本地测试      │    │ • 质量检查      │    │ • 版本发布      │
│ • 代码提交      │    │ • 安全扫描      │    │ • 更新推送      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   版本控制       │    │   CI/CD 流水线   │    │   用户设备       │
│                │    │                │    │                │
│ • Git 仓库      │    │ • GitHub Actions│    │ • 自动更新      │
│ • 分支管理      │    │ • 构建缓存      │    │ • 错误上报      │
│ • 代码审查      │    │ • 测试覆盖      │    │ • 使用统计      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术栈选择

```json
{
  "构建工具": {
    "主构建": "Electron Builder",
    "打包": "Webpack 5",
    "代码压缩": "Terser",
    "资源优化": "ImageMin"
  },
  "CI/CD": {
    "平台": "GitHub Actions",
    "缓存": "GitHub Cache",
    "制品存储": "GitHub Releases",
    "通知": "Slack/钉钉"
  },
  "分发渠道": {
    "官方网站": "直接下载",
    "应用商店": "Microsoft Store, Mac App Store",
    "包管理器": "Homebrew, Chocolatey, Snap",
    "企业分发": "内部更新服务器"
  },
  "监控运维": {
    "错误监控": "Sentry",
    "性能监控": "Electron APM",
    "使用统计": "Google Analytics",
    "日志收集": "Winston + LogRocket"
  }
}
```

## 2. 构建配置

### 2.1 Electron Builder 配置

```json
{
  "name": "offerhelper",
  "productName": "OfferHelper",
  "version": "1.0.0",
  "description": "程序员面试AI辅助助手",
  "main": "dist/main.js",
  "homepage": "https://offerhelper.com",
  "author": {
    "name": "OfferHelper Team",
    "email": "support@offerhelper.com"
  },
  "build": {
    "appId": "com.offerhelper.desktop",
    "productName": "OfferHelper",
    "copyright": "Copyright © 2024 OfferHelper Team",
    "directories": {
      "output": "release",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "extraResources": [
      {
        "from": "resources/",
        "to": "resources/",
        "filter": ["**/*"]
      }
    ],
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "build/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        },
        {
          "target": "zip",
          "arch": ["x64", "arm64"]
        }
      ]
    },
    "win": {
      "icon": "build/icon.ico",
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x64"]
        }
      ]
    },
    "linux": {
      "icon": "build/icon.png",
      "target": [
        {
          "target": "AppImage",
          "arch": ["x64"]
        },
        {
          "target": "deb",
          "arch": ["x64"]
        },
        {
          "target": "rpm",
          "arch": ["x64"]
        }
      ]
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "installerIcon": "build/icon.ico",
      "uninstallerIcon": "build/icon.ico",
      "installerHeaderIcon": "build/icon.ico",
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "OfferHelper"
    },
    "dmg": {
      "title": "OfferHelper ${version}",
      "icon": "build/icon.icns",
      "background": "build/dmg-background.png",
      "contents": [
        {
          "x": 130,
          "y": 220,
          "type": "file"
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ]
    },
    "publish": [
      {
        "provider": "github",
        "owner": "offerhelper",
        "repo": "desktop"
      }
    ]
  }
}
```

### 2.2 构建脚本

```json
{
  "scripts": {
    "dev": "concurrently \"npm run dev:main\" \"npm run dev:renderer\"",
    "dev:main": "webpack --config webpack.main.config.js --mode development --watch",
    "dev:renderer": "webpack serve --config webpack.renderer.config.js --mode development",
    "build": "npm run build:main && npm run build:renderer",
    "build:main": "webpack --config webpack.main.config.js --mode production",
    "build:renderer": "webpack --config webpack.renderer.config.js --mode production",
    "dist": "npm run build && electron-builder",
    "dist:mac": "npm run build && electron-builder --mac",
    "dist:win": "npm run build && electron-builder --win",
    "dist:linux": "npm run build && electron-builder --linux",
    "pack": "npm run build && electron-builder --dir",
    "postinstall": "electron-builder install-app-deps",
    "test": "jest",
    "test:e2e": "playwright test",
    "lint": "eslint src --ext .ts,.tsx",
    "lint:fix": "eslint src --ext .ts,.tsx --fix",
    "type-check": "tsc --noEmit",
    "clean": "rimraf dist release",
    "rebuild": "npm run clean && npm install && npm run build"
  }
}
```

### 2.3 Webpack 配置

```javascript
// webpack.main.config.js
const path = require('path');

module.exports = {
  target: 'electron-main',
  entry: './src/main/main.ts',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'main.js'
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader',
        exclude: /node_modules/
      }
    ]
  },
  resolve: {
    extensions: ['.ts', '.js']
  },
  node: {
    __dirname: false,
    __filename: false
  },
  externals: {
    'better-sqlite3': 'commonjs better-sqlite3',
    'ffi-napi': 'commonjs ffi-napi'
  }
};

// webpack.renderer.config.js
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

module.exports = (env, argv) => {
  const isProduction = argv.mode === 'production';

  return {
    target: 'electron-renderer',
    entry: './src/renderer/index.tsx',
    output: {
      path: path.resolve(__dirname, 'dist'),
      filename: 'renderer.js'
    },
    module: {
      rules: [
        {
          test: /\.tsx?$/,
          use: 'ts-loader',
          exclude: /node_modules/
        },
        {
          test: /\.css$/,
          use: [
            isProduction ? MiniCssExtractPlugin.loader : 'style-loader',
            'css-loader',
            'postcss-loader'
          ]
        },
        {
          test: /\.(png|jpg|gif|svg)$/,
          type: 'asset/resource'
        }
      ]
    },
    resolve: {
      extensions: ['.tsx', '.ts', '.js'],
      alias: {
        '@': path.resolve(__dirname, 'src/renderer')
      }
    },
    plugins: [
      new HtmlWebpackPlugin({
        template: './src/renderer/index.html'
      }),
      ...(isProduction ? [new MiniCssExtractPlugin()] : [])
    ],
    devServer: {
      port: 3000,
      hot: true
    }
  };
};
```

## 3. CI/CD 流水线

### 3.1 GitHub Actions 配置

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm test

      - name: Run E2E tests
        run: npm run test:e2e

  build:
    needs: test
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build distributables
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-${{ matrix.os }}
          path: release/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-macos-latest/**/*
            dist-windows-latest/**/*
            dist-ubuntu-latest/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 3.2 代码质量检查

```yaml
# .github/workflows/quality.yml
name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format=json --output-file=eslint-report.json
        continue-on-error: true

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,css,md}"

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run dependency check
        run: npx depcheck

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

### 3.3 自动化测试

```yaml
# .github/workflows/test.yml
name: Automated Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --coverage --watchAll=false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  e2e-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Install Playwright
        run: npx playwright install

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report-${{ matrix.os }}
          path: playwright-report/
```

## 4. 代码签名与安全

### 4.1 macOS 代码签名

```xml
<!-- build/entitlements.mac.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>com.apple.security.cs.allow-jit</key>
  <true/>
  <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
  <true/>
  <key>com.apple.security.cs.disable-library-validation</key>
  <true/>
  <key>com.apple.security.device.microphone</key>
  <true/>
  <key>com.apple.security.device.camera</key>
  <false/>
  <key>com.apple.security.network.client</key>
  <true/>
  <key>com.apple.security.network.server</key>
  <false/>
  <key>com.apple.security.files.user-selected.read-write</key>
  <true/>
</dict>
</plist>
```

```bash
# 签名脚本
#!/bin/bash

# 设置环境变量
export CSC_LINK="path/to/certificate.p12"
export CSC_KEY_PASSWORD="certificate_password"
export APPLE_ID="developer@example.com"
export APPLE_ID_PASSWORD="app_specific_password"

# 构建并签名
npm run dist:mac

# 公证应用
xcrun altool --notarize-app \
  --primary-bundle-id "com.offerhelper.desktop" \
  --username "$APPLE_ID" \
  --password "$APPLE_ID_PASSWORD" \
  --file "release/OfferHelper-1.0.0.dmg"
```

### 4.2 Windows 代码签名

```javascript
// 签名配置
const { execSync } = require('child_process');
const path = require('path');

function signWindows() {
  const signtool = 'C:\\Program Files (x86)\\Windows Kits\\10\\bin\\10.0.19041.0\\x64\\signtool.exe';
  const certificate = process.env.WIN_CSC_LINK;
  const password = process.env.WIN_CSC_KEY_PASSWORD;

  const files = [
    'release/OfferHelper Setup 1.0.0.exe',
    'release/OfferHelper 1.0.0.exe'
  ];

  files.forEach(file => {
    if (require('fs').existsSync(file)) {
      const command = `"${signtool}" sign /f "${certificate}" /p "${password}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "${file}"`;
      execSync(command, { stdio: 'inherit' });
      console.log(`已签名: ${file}`);
    }
  });
}

module.exports = { signWindows };
```

### 4.3 安全检查脚本

```javascript
// scripts/security-check.js
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

class SecurityChecker {
  constructor() {
    this.vulnerabilities = [];
    this.securityRules = [
      this.checkHardcodedSecrets,
      this.checkInsecureProtocols,
      this.checkDangerousPermissions,
      this.checkOutdatedDependencies
    ];
  }

  async runAllChecks() {
    console.log('🔍 开始安全检查...');

    for (const rule of this.securityRules) {
      await rule.call(this);
    }

    this.generateReport();
  }

  checkHardcodedSecrets() {
    const patterns = [
      /api[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /secret[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /password\s*[:=]\s*['"][^'"]+['"]/gi,
      /token\s*[:=]\s*['"][^'"]+['"]/gi
    ];

    this.scanFiles('src', patterns, '硬编码密钥');
  }

  checkInsecureProtocols() {
    const patterns = [
      /http:\/\/(?!localhost|127\.0\.0\.1)/gi,
      /ftp:\/\//gi
    ];

    this.scanFiles('src', patterns, '不安全协议');
  }

  checkDangerousPermissions() {
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const dangerousPerms = [
      'nodeIntegration: true',
      'contextIsolation: false',
      'webSecurity: false'
    ];

    // 检查是否有危险的 Electron 配置
    this.scanFiles('src', dangerousPerms.map(p => new RegExp(p, 'gi')), '危险权限');
  }

  async checkOutdatedDependencies() {
    try {
      const { execSync } = require('child_process');
      const auditResult = execSync('npm audit --json', { encoding: 'utf8' });
      const audit = JSON.parse(auditResult);

      if (audit.metadata.vulnerabilities.total > 0) {
        this.vulnerabilities.push({
          type: '依赖漏洞',
          count: audit.metadata.vulnerabilities.total,
          details: audit.advisories
        });
      }
    } catch (error) {
      console.warn('依赖检查失败:', error.message);
    }
  }

  scanFiles(dir, patterns, type) {
    const files = this.getAllFiles(dir);

    files.forEach(file => {
      const content = fs.readFileSync(file, 'utf8');

      patterns.forEach(pattern => {
        const matches = content.match(pattern);
        if (matches) {
          this.vulnerabilities.push({
            type,
            file,
            matches: matches.length,
            details: matches
          });
        }
      });
    });
  }

  getAllFiles(dir) {
    let files = [];
    const items = fs.readdirSync(dir);

    items.forEach(item => {
      const fullPath = path.join(dir, item);
      const stat = fs.statSync(fullPath);

      if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
        files = files.concat(this.getAllFiles(fullPath));
      } else if (stat.isFile() && /\.(js|ts|tsx|jsx)$/.test(item)) {
        files.push(fullPath);
      }
    });

    return files;
  }

  generateReport() {
    console.log('\n📊 安全检查报告');
    console.log('='.repeat(50));

    if (this.vulnerabilities.length === 0) {
      console.log('✅ 未发现安全问题');
      return;
    }

    this.vulnerabilities.forEach((vuln, index) => {
      console.log(`\n${index + 1}. ${vuln.type}`);
      if (vuln.file) {
        console.log(`   文件: ${vuln.file}`);
        console.log(`   匹配: ${vuln.matches} 个`);
      }
      if (vuln.count) {
        console.log(`   数量: ${vuln.count}`);
      }
    });

    console.log(`\n⚠️  总计发现 ${this.vulnerabilities.length} 个安全问题`);

    // 如果有高危漏洞，退出构建
    const criticalIssues = this.vulnerabilities.filter(v =>
      v.type === '硬编码密钥' || v.type === '危险权限'
    );

    if (criticalIssues.length > 0) {
      console.error('❌ 发现高危安全问题，构建终止');
      process.exit(1);
    }
  }
}

// 运行安全检查
if (require.main === module) {
  const checker = new SecurityChecker();
  checker.runAllChecks();
}

module.exports = SecurityChecker;
```

## 5. 自动更新系统

### 5.1 更新服务器配置

```javascript
// update-server/server.js
const express = require('express');
const semver = require('semver');
const app = express();

// 版本信息存储
const versions = {
  'darwin': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-x64.zip',
      signature: 'signature_hash_here'
    },
    'arm64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-arm64.zip',
      signature: 'signature_hash_here'
    }
  },
  'win32': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-win-x64.exe',
      signature: 'signature_hash_here'
    }
  },
  'linux': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-linux-x64.AppImage',
      signature: 'signature_hash_here'
    }
  }
};

// 检查更新接口
app.get('/update/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  const platformVersions = versions[platform];
  if (!platformVersions) {
    return res.status(404).json({ error: 'Platform not supported' });
  }

  const archVersion = platformVersions[arch];
  if (!archVersion) {
    return res.status(404).json({ error: 'Architecture not supported' });
  }

  // 比较版本
  if (semver.gt(archVersion.version, version)) {
    res.json({
      version: archVersion.version,
      url: archVersion.url,
      signature: archVersion.signature,
      releaseNotes: `更新到版本 ${archVersion.version}`
    });
  } else {
    res.status(204).send(); // 无更新
  }
});

// 下载统计
app.get('/download/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  // 记录下载统计
  console.log(`下载: ${platform}-${arch}-${version}`);

  // 重定向到实际下载地址
  const platformVersions = versions[platform];
  const archVersion = platformVersions?.[arch];

  if (archVersion && archVersion.version === version) {
    res.redirect(archVersion.url);
  } else {
    res.status(404).json({ error: 'Version not found' });
  }
});

app.listen(3001, () => {
  console.log('更新服务器运行在端口 3001');
});
```

### 5.2 客户端更新逻辑

```typescript
// src/main/updater.ts
import { autoUpdater } from 'electron-updater';
import { dialog, BrowserWindow } from 'electron';
import log from 'electron-log';

class AppUpdater {
  private mainWindow: BrowserWindow;
  private updateCheckInterval: NodeJS.Timeout | null = null;

  constructor(mainWindow: BrowserWindow) {
    this.mainWindow = mainWindow;
    this.setupUpdater();
  }

  private setupUpdater(): void {
    // 配置更新服务器
    autoUpdater.setFeedURL({
      provider: 'generic',
      url: 'https://api.offerhelper.com/updates'
    });

    // 配置日志
    autoUpdater.logger = log;
    (autoUpdater.logger as any).transports.file.level = 'info';

    // 事件监听
    autoUpdater.on('checking-for-update', () => {
      log.info('检查更新中...');
      this.sendStatusToWindow('checking-for-update');
    });

    autoUpdater.on('update-available', (info) => {
      log.info('发现新版本:', info.version);
      this.sendStatusToWindow('update-available', info);
      this.showUpdateDialog(info);
    });

    autoUpdater.on('update-not-available', (info) => {
      log.info('当前已是最新版本');
      this.sendStatusToWindow('update-not-available', info);
    });

    autoUpdater.on('error', (err) => {
      log.error('更新错误:', err);
      this.sendStatusToWindow('update-error', err);
    });

    autoUpdater.on('download-progress', (progressObj) => {
      let logMessage = `下载速度: ${progressObj.bytesPerSecond}`;
      logMessage += ` - 已下载 ${progressObj.percent}%`;
      logMessage += ` (${progressObj.transferred}/${progressObj.total})`;

      log.info(logMessage);
      this.sendStatusToWindow('download-progress', progressObj);
    });

    autoUpdater.on('update-downloaded', (info) => {
      log.info('更新下载完成');
      this.sendStatusToWindow('update-downloaded', info);
      this.showRestartDialog();
    });
  }

  public checkForUpdates(): void {
    autoUpdater.checkForUpdatesAndNotify();
  }

  public startAutoCheck(): void {
    // 每小时检查一次更新
    this.updateCheckInterval = setInterval(() => {
      this.checkForUpdates();
    }, 60 * 60 * 1000);

    // 启动时检查
    setTimeout(() => {
      this.checkForUpdates();
    }, 5000);
  }

  public stopAutoCheck(): void {
    if (this.updateCheckInterval) {
      clearInterval(this.updateCheckInterval);
      this.updateCheckInterval = null;
    }
  }

  private sendStatusToWindow(event: string, data?: any): void {
    if (this.mainWindow && !this.mainWindow.isDestroyed()) {
      this.mainWindow.webContents.send('updater-message', { event, data });
    }
  }

  private showUpdateDialog(info: any): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['立即更新', '稍后提醒', '跳过此版本'],
      defaultId: 0,
      title: '发现新版本',
      message: `发现新版本 ${info.version}`,
      detail: '是否立即下载并安装更新？'
    });

    switch (response) {
      case 0: // 立即更新
        autoUpdater.downloadUpdate();
        break;
      case 1: // 稍后提醒
        // 1小时后再次提醒
        setTimeout(() => {
          this.showUpdateDialog(info);
        }, 60 * 60 * 1000);
        break;
      case 2: // 跳过此版本
        // 记录跳过的版本
        this.skipVersion(info.version);
        break;
    }
  }

  private showRestartDialog(): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['立即重启', '稍后重启'],
      defaultId: 0,
      title: '更新已下载',
      message: '更新已下载完成',
      detail: '需要重启应用以完成更新。'
    });

    if (response === 0) {
      autoUpdater.quitAndInstall();
    }
  }

  private skipVersion(version: string): void {
    // 将跳过的版本保存到本地存储
    const { app } = require('electron');
    const fs = require('fs');
    const path = require('path');

    const configPath = path.join(app.getPath('userData'), 'update-config.json');
    let config = {};

    try {
      if (fs.existsSync(configPath)) {
        config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
      }
    } catch (error) {
      log.error('读取更新配置失败:', error);
    }

    config.skippedVersions = config.skippedVersions || [];
    if (!config.skippedVersions.includes(version)) {
      config.skippedVersions.push(version);
    }

    try {
      fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    } catch (error) {
      log.error('保存更新配置失败:', error);
    }
  }
}

export default AppUpdater;
```

### 5.3 渲染进程更新界面

```tsx
// src/renderer/components/UpdateNotification.tsx
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface UpdateInfo {
  version: string;
  releaseNotes?: string;
}

interface UpdateProgress {
  percent: number;
  bytesPerSecond: number;
  transferred: number;
  total: number;
}

const UpdateNotification: React.FC = () => {
  const [updateState, setUpdateState] = useState<string>('');
  const [updateInfo, setUpdateInfo] = useState<UpdateInfo | null>(null);
  const [downloadProgress, setDownloadProgress] = useState<UpdateProgress | null>(null);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    // 监听更新事件
    const handleUpdaterMessage = (event: any, { event: updateEvent, data }: any) => {
      setUpdateState(updateEvent);

      switch (updateEvent) {
        case 'update-available':
          setUpdateInfo(data);
          setIsVisible(true);
          break;
        case 'download-progress':
          setDownloadProgress(data);
          break;
        case 'update-downloaded':
          setDownloadProgress(null);
          break;
        case 'update-not-available':
        case 'update-error':
          setTimeout(() => setIsVisible(false), 3000);
          break;
      }
    };

    window.electron?.ipcRenderer.on('updater-message', handleUpdaterMessage);

    return () => {
      window.electron?.ipcRenderer.removeListener('updater-message', handleUpdaterMessage);
    };
  }, []);

  const getStatusText = () => {
    switch (updateState) {
      case 'checking-for-update':
        return '检查更新中...';
      case 'update-available':
        return `发现新版本 ${updateInfo?.version}`;
      case 'download-progress':
        return `下载中... ${Math.round(downloadProgress?.percent || 0)}%`;
      case 'update-downloaded':
        return '更新已下载完成';
      case 'update-not-available':
        return '当前已是最新版本';
      case 'update-error':
        return '更新检查失败';
      default:
        return '';
    }
  };

  const formatBytes = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const formatSpeed = (bytesPerSecond: number) => {
    return formatBytes(bytesPerSecond) + '/s';
  };

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          className="update-notification"
          initial={{ opacity: 0, y: -50 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -50 }}
          transition={{ duration: 0.3 }}
        >
          <div className="update-content">
            <div className="update-icon">
              {updateState === 'checking-for-update' && '🔍'}
              {updateState === 'update-available' && '🎉'}
              {updateState === 'download-progress' && '⬇️'}
              {updateState === 'update-downloaded' && '✅'}
              {updateState === 'update-not-available' && 'ℹ️'}
              {updateState === 'update-error' && '❌'}
            </div>

            <div className="update-info">
              <div className="update-title">{getStatusText()}</div>

              {downloadProgress && (
                <div className="download-info">
                  <div className="progress-bar">
                    <div
                      className="progress-fill"
                      style={{ width: `${downloadProgress.percent}%` }}
                    />
                  </div>
                  <div className="download-stats">
                    <span>{formatBytes(downloadProgress.transferred)} / {formatBytes(downloadProgress.total)}</span>
                    <span>{formatSpeed(downloadProgress.bytesPerSecond)}</span>
                  </div>
                </div>
              )}

              {updateInfo?.releaseNotes && (
                <div className="release-notes">
                  {updateInfo.releaseNotes}
                </div>
              )}
            </div>

            <button
              className="close-btn"
              onClick={() => setIsVisible(false)}
            >
              ×
            </button>
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default UpdateNotification;
```

## 6. 监控与日志系统

### 6.1 错误监控配置

```typescript
// src/main/monitoring.ts
import * as Sentry from '@sentry/electron';
import { app } from 'electron';

class MonitoringService {
  private isInitialized = false;

  public initialize(): void {
    if (this.isInitialized) return;

    // 初始化 Sentry
    Sentry.init({
      dsn: process.env.SENTRY_DSN,
      environment: process.env.NODE_ENV || 'development',
      release: app.getVersion(),
      beforeSend: this.filterSensitiveData,
      integrations: [
        new Sentry.Integrations.MainThreadProfiling(),
      ],
      tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    });

    // 设置用户上下文
    Sentry.setContext('app', {
      name: app.getName(),
      version: app.getVersion(),
      platform: process.platform,
      arch: process.arch,
    });

    this.isInitialized = true;
  }

  private filterSensitiveData(event: Sentry.Event): Sentry.Event | null {
    // 过滤敏感信息
    if (event.exception) {
      event.exception.values?.forEach(exception => {
        if (exception.stacktrace?.frames) {
          exception.stacktrace.frames.forEach(frame => {
            // 移除文件路径中的用户信息
            if (frame.filename) {
              frame.filename = frame.filename.replace(/\/Users\/[^\/]+/, '/Users/***');
              frame.filename = frame.filename.replace(/C:\\Users\\[^\\]+/, 'C:\\Users\\***');
            }
          });
        }
      });
    }

    // 过滤包含密钥的错误
    const sensitiveKeywords = ['password', 'token', 'key', 'secret'];
    const errorMessage = event.message || '';

    if (sensitiveKeywords.some(keyword =>
      errorMessage.toLowerCase().includes(keyword)
    )) {
      return null; // 不发送包含敏感信息的错误
    }

    return event;
  }

  public captureException(error: Error, context?: any): void {
    if (!this.isInitialized) return;

    Sentry.withScope(scope => {
      if (context) {
        scope.setContext('additional', context);
      }
      Sentry.captureException(error);
    });
  }

  public captureMessage(message: string, level: Sentry.SeverityLevel = 'info'): void {
    if (!this.isInitialized) return;

    Sentry.captureMessage(message, level);
  }

  public setUser(user: { id: string; email?: string }): void {
    if (!this.isInitialized) return;

    Sentry.setUser(user);
  }

  public addBreadcrumb(breadcrumb: Sentry.Breadcrumb): void {
    if (!this.isInitialized) return;

    Sentry.addBreadcrumb(breadcrumb);
  }
}

export const monitoring = new MonitoringService();
```

### 6.2 性能监控

```typescript
// src/main/performance.ts
import { app, powerMonitor } from 'electron';
import * as os from 'os';

interface PerformanceMetrics {
  timestamp: number;
  memory: {
    heapUsed: number;
    heapTotal: number;
    external: number;
    rss: number;
  };
  cpu: {
    usage: number;
    loadAverage: number[];
  };
  system: {
    platform: string;
    arch: string;
    totalMemory: number;
    freeMemory: number;
    uptime: number;
  };
  app: {
    version: string;
    uptime: number;
    isOnBattery?: boolean;
  };
}

class PerformanceMonitor {
  private metrics: PerformanceMetrics[] = [];
  private intervalId: NodeJS.Timeout | null = null;
  private readonly maxMetrics = 1000; // 保留最近1000条记录

  public start(): void {
    if (this.intervalId) return;

    // 每30秒收集一次性能数据
    this.intervalId = setInterval(() => {
      this.collectMetrics();
    }, 30000);

    // 立即收集一次
    this.collectMetrics();
  }

  public stop(): void {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
  }

  private collectMetrics(): void {
    const memUsage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();

    const metrics: PerformanceMetrics = {
      timestamp: Date.now(),
      memory: {
        heapUsed: memUsage.heapUsed,
        heapTotal: memUsage.heapTotal,
        external: memUsage.external,
        rss: memUsage.rss,
      },
      cpu: {
        usage: this.calculateCpuUsage(cpuUsage),
        loadAverage: os.loadavg(),
      },
      system: {
        platform: os.platform(),
        arch: os.arch(),
        totalMemory: os.totalmem(),
        freeMemory: os.freemem(),
        uptime: os.uptime(),
      },
      app: {
        version: app.getVersion(),
        uptime: process.uptime(),
        isOnBattery: powerMonitor.isOnBatteryPower?.(),
      },
    };

    this.metrics.push(metrics);

    // 保持数组大小
    if (this.metrics.length > this.maxMetrics) {
      this.metrics.shift();
    }

    // 检查性能警告
    this.checkPerformanceWarnings(metrics);
  }

  private calculateCpuUsage(cpuUsage: NodeJS.CpuUsage): number {
    // 简化的CPU使用率计算
    const totalUsage = cpuUsage.user + cpuUsage.system;
    return totalUsage / 1000000; // 转换为毫秒
  }

  private checkPerformanceWarnings(metrics: PerformanceMetrics): void {
    // 内存使用警告
    const memoryUsageMB = metrics.memory.heapUsed / 1024 / 1024;
    if (memoryUsageMB > 200) {
      console.warn(`内存使用过高: ${memoryUsageMB.toFixed(2)}MB`);

      // 发送到监控服务
      monitoring.captureMessage(
        `高内存使用: ${memoryUsageMB.toFixed(2)}MB`,
        'warning'
      );
    }

    // CPU使用警告
    if (metrics.cpu.usage > 80) {
      console.warn(`CPU使用率过高: ${metrics.cpu.usage.toFixed(2)}%`);

      monitoring.captureMessage(
        `高CPU使用: ${metrics.cpu.usage.toFixed(2)}%`,
        'warning'
      );
    }

    // 系统内存不足警告
    const freeMemoryPercent = (metrics.system.freeMemory / metrics.system.totalMemory) * 100;
    if (freeMemoryPercent < 10) {
      console.warn(`系统内存不足: ${freeMemoryPercent.toFixed(2)}%`);

      monitoring.captureMessage(
        `系统内存不足: ${freeMemoryPercent.toFixed(2)}%`,
        'warning'
      );
    }
  }

  public getMetrics(): PerformanceMetrics[] {
    return [...this.metrics];
  }

  public getLatestMetrics(): PerformanceMetrics | null {
    return this.metrics.length > 0 ? this.metrics[this.metrics.length - 1] : null;
  }

  public getAverageMetrics(minutes: number = 5): Partial<PerformanceMetrics> | null {
    const cutoffTime = Date.now() - (minutes * 60 * 1000);
    const recentMetrics = this.metrics.filter(m => m.timestamp > cutoffTime);

    if (recentMetrics.length === 0) return null;

    const avgMemory = recentMetrics.reduce((sum, m) => sum + m.memory.heapUsed, 0) / recentMetrics.length;
    const avgCpu = recentMetrics.reduce((sum, m) => sum + m.cpu.usage, 0) / recentMetrics.length;

    return {
      memory: {
        heapUsed: avgMemory,
        heapTotal: 0,
        external: 0,
        rss: 0,
      },
      cpu: {
        usage: avgCpu,
        loadAverage: [],
      },
    };
  }
}

export const performanceMonitor = new PerformanceMonitor();
```

### 6.3 使用统计

```typescript
// src/main/analytics.ts
import { app, ipcMain } from 'electron';
import * as path from 'path';
import * as fs from 'fs';

interface UsageEvent {
  event: string;
  properties?: Record<string, any>;
  timestamp: number;
  sessionId: string;
  userId?: string;
}

interface SessionInfo {
  sessionId: string;
  startTime: number;
  endTime?: number;
  events: UsageEvent[];
  userAgent: string;
  version: string;
}

class AnalyticsService {
  private currentSession: SessionInfo | null = null;
  private userId: string | null = null;
  private analyticsPath: string;
  private batchSize = 50;
  private flushInterval = 60000; // 1分钟
  private flushTimer: NodeJS.Timeout | null = null;

  constructor() {
    this.analyticsPath = path.join(app.getPath('userData'), 'analytics');
    this.ensureAnalyticsDirectory();
    this.setupIpcHandlers();
  }

  private ensureAnalyticsDirectory(): void {
    if (!fs.existsSync(this.analyticsPath)) {
      fs.mkdirSync(this.analyticsPath, { recursive: true });
    }
  }

  private setupIpcHandlers(): void {
    ipcMain.handle('analytics:track', (event, eventName: string, properties?: Record<string, any>) => {
      this.track(eventName, properties);
    });

    ipcMain.handle('analytics:setUser', (event, userId: string) => {
      this.setUserId(userId);
    });
  }

  public startSession(): void {
    this.currentSession = {
      sessionId: this.generateSessionId(),
      startTime: Date.now(),
      events: [],
      userAgent: `OfferHelper/${app.getVersion()} (${process.platform})`,
      version: app.getVersion(),
    };

    this.track('session_start');
    this.startFlushTimer();
  }

  public endSession(): void {
    if (this.currentSession) {
      this.currentSession.endTime = Date.now();
      this.track('session_end');
      this.flush();
      this.currentSession = null;
    }

    this.stopFlushTimer();
  }

  public track(event: string, properties?: Record<string, any>): void {
    if (!this.currentSession) return;

    const usageEvent: UsageEvent = {
      event,
      properties,
      timestamp: Date.now(),
      sessionId: this.currentSession.sessionId,
      userId: this.userId || undefined,
    };

    this.currentSession.events.push(usageEvent);

    // 自动刷新大批量事件
    if (this.currentSession.events.length >= this.batchSize) {
      this.flush();
    }
  }

  public setUserId(userId: string): void {
    this.userId = userId;
  }

  private flush(): void {
    if (!this.currentSession || this.currentSession.events.length === 0) return;

    const sessionData = { ...this.currentSession };
    const filename = `session_${sessionData.sessionId}_${Date.now()}.json`;
    const filepath = path.join(this.analyticsPath, filename);

    try {
      fs.writeFileSync(filepath, JSON.stringify(sessionData, null, 2));
      console.log(`分析数据已保存: ${filename}`);

      // 清空当前会话的事件
      this.currentSession.events = [];

      // 尝试上传数据
      this.uploadAnalyticsData();
    } catch (error) {
      console.error('保存分析数据失败:', error);
    }
  }

  private async uploadAnalyticsData(): void {
    try {
      const files = fs.readdirSync(this.analyticsPath)
        .filter(file => file.endsWith('.json'))
        .slice(0, 10); // 每次最多上传10个文件

      for (const file of files) {
        const filepath = path.join(this.analyticsPath, file);
        const data = JSON.parse(fs.readFileSync(filepath, 'utf8'));

        // 发送到分析服务
        const response = await fetch('https://api.offerhelper.com/analytics', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'User-Agent': data.userAgent,
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // 上传成功，删除本地文件
          fs.unlinkSync(filepath);
          console.log(`分析数据上传成功: ${file}`);
        } else {
          console.warn(`分析数据上传失败: ${file}`, response.status);
          break; // 停止上传其他文件
        }
      }
    } catch (error) {
      console.error('上传分析数据失败:', error);
    }
  }

  private startFlushTimer(): void {
    this.flushTimer = setInterval(() => {
      this.flush();
    }, this.flushInterval);
  }

  private stopFlushTimer(): void {
    if (this.flushTimer) {
      clearInterval(this.flushTimer);
      this.flushTimer = null;
    }
  }

  private generateSessionId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  // 预定义的事件跟踪方法
  public trackAppLaunch(): void {
    this.track('app_launch', {
      platform: process.platform,
      arch: process.arch,
      version: app.getVersion(),
    });
  }

  public trackFeatureUsage(feature: string, duration?: number): void {
    this.track('feature_usage', {
      feature,
      duration,
    });
  }

  public trackError(error: Error, context?: string): void {
    this.track('error', {
      message: error.message,
      stack: error.stack,
      context,
    });
  }

  public trackPerformance(metric: string, value: number, unit: string): void {
    this.track('performance', {
      metric,
      value,
      unit,
    });
  }
}

export const analytics = new AnalyticsService();
```

## 7. 运维监控面板

### 7.1 监控面板界面

```tsx
// src/renderer/components/MonitoringDashboard.tsx
import React, { useState, useEffect } from 'react';
import { Line, Bar, Doughnut } from 'react-chartjs-2';

interface MonitoringDashboardProps {
  isVisible: boolean;
  onClose: () => void;
}

const MonitoringDashboard: React.FC<MonitoringDashboardProps> = ({
  isVisible,
  onClose
}) => {
  const [metrics, setMetrics] = useState<any[]>([]);
  const [systemInfo, setSystemInfo] = useState<any>(null);
  const [errors, setErrors] = useState<any[]>([]);

  useEffect(() => {
    if (isVisible) {
      loadMonitoringData();
      const interval = setInterval(loadMonitoringData, 5000);
      return () => clearInterval(interval);
    }
  }, [isVisible]);

  const loadMonitoringData = async () => {
    try {
      // 获取性能指标
      const metricsData = await window.electron?.ipcRenderer.invoke('monitoring:getMetrics');
      setMetrics(metricsData || []);

      // 获取系统信息
      const systemData = await window.electron?.ipcRenderer.invoke('monitoring:getSystemInfo');
      setSystemInfo(systemData);

      // 获取错误日志
      const errorsData = await window.electron?.ipcRenderer.invoke('monitoring:getErrors');
      setErrors(errorsData || []);
    } catch (error) {
      console.error('加载监控数据失败:', error);
    }
  };

  const memoryChartData = {
    labels: metrics.map(m => new Date(m.timestamp).toLocaleTimeString()),
    datasets: [
      {
        label: '堆内存使用 (MB)',
        data: metrics.map(m => m.memory.heapUsed / 1024 / 1024),
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1,
      },
      {
        label: '总内存 (MB)',
        data: metrics.map(m => m.memory.heapTotal / 1024 / 1024),
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        tension: 0.1,
      },
    ],
  };

  const cpuChartData = {
    labels: metrics.map(m => new Date(m.timestamp).toLocaleTimeString()),
    datasets: [
      {
        label: 'CPU 使用率 (%)',
        data: metrics.map(m => m.cpu.usage),
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        tension: 0.1,
      },
    ],
  };

  const errorTypeData = {
    labels: ['JavaScript错误', '网络错误', '系统错误', '其他'],
    datasets: [
      {
        data: [
          errors.filter(e => e.type === 'javascript').length,
          errors.filter(e => e.type === 'network').length,
          errors.filter(e => e.type === 'system').length,
          errors.filter(e => !['javascript', 'network', 'system'].includes(e.type)).length,
        ],
        backgroundColor: [
          'rgba(255, 99, 132, 0.8)',
          'rgba(54, 162, 235, 0.8)',
          'rgba(255, 205, 86, 0.8)',
          'rgba(75, 192, 192, 0.8)',
        ],
      },
    ],
  };

  if (!isVisible) return null;

  return (
    <div className="monitoring-dashboard">
      <div className="dashboard-header">
        <h2>系统监控面板</h2>
        <button onClick={onClose} className="close-btn">×</button>
      </div>

      <div className="dashboard-content">
        {/* 系统概览 */}
        <div className="overview-section">
          <div className="metric-card">
            <h3>应用信息</h3>
            <div className="metric-value">
              <span>版本: {systemInfo?.version}</span>
              <span>运行时间: {Math.floor((systemInfo?.uptime || 0) / 60)} 分钟</span>
              <span>平台: {systemInfo?.platform}</span>
            </div>
          </div>

          <div className="metric-card">
            <h3>内存使用</h3>
            <div className="metric-value">
              {metrics.length > 0 && (
                <>
                  <span>当前: {(metrics[metrics.length - 1].memory.heapUsed / 1024 / 1024).toFixed(2)} MB</span>
                  <span>峰值: {Math.max(...metrics.map(m => m.memory.heapUsed / 1024 / 1024)).toFixed(2)} MB</span>
                </>
              )}
            </div>
          </div>

          <div className="metric-card">
            <h3>错误统计</h3>
            <div className="metric-value">
              <span>总错误: {errors.length}</span>
              <span>最近1小时: {errors.filter(e => Date.now() - e.timestamp < 3600000).length}</span>
            </div>
          </div>
        </div>

        {/* 图表区域 */}
        <div className="charts-section">
          <div className="chart-container">
            <h3>内存使用趋势</h3>
            <Line data={memoryChartData} options={{
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: '内存 (MB)'
                  }
                }
              }
            }} />
          </div>

          <div className="chart-container">
            <h3>CPU 使用趋势</h3>
            <Line data={cpuChartData} options={{
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'CPU (%)'
                  }
                }
              }
            }} />
          </div>

          <div className="chart-container">
            <h3>错误类型分布</h3>
            <Doughnut data={errorTypeData} options={{
              responsive: true,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }} />
          </div>
        </div>

        {/* 错误日志 */}
        <div className="errors-section">
          <h3>最近错误</h3>
          <div className="error-list">
            {errors.slice(-10).reverse().map((error, index) => (
              <div key={index} className="error-item">
                <div className="error-time">
                  {new Date(error.timestamp).toLocaleString()}
                </div>
                <div className="error-message">{error.message}</div>
                <div className="error-type">{error.type}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

export default MonitoringDashboard;
```

### 7.2 监控面板样式

```css
/* 监控面板样式 */
.monitoring-dashboard {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 1000;
  overflow-y: auto;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.dashboard-header h2 {
  color: #f3f4f6;
  margin: 0;
}

.dashboard-content {
  padding: 20px;
}

.overview-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.metric-card {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.metric-card h3 {
  color: #f3f4f6;
  margin: 0 0 15px 0;
  font-size: 16px;
}

.metric-value {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.metric-value span {
  color: #d1d5db;
  font-size: 14px;
}

.charts-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-bottom: 30px;
}

.chart-container {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.chart-container h3 {
  color: #f3f4f6;
  margin: 0 0 20px 0;
  font-size: 16px;
}

.errors-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.errors-section h3 {
  color: #f3f4f6;
  margin: 0 0 20px 0;
  font-size: 16px;
}

.error-list {
  max-height: 300px;
  overflow-y: auto;
}

.error-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  gap: 15px;
}

.error-item:last-child {
  border-bottom: none;
}

.error-time {
  color: #9ca3af;
  font-size: 12px;
  white-space: nowrap;
}

.error-message {
  color: #f3f4f6;
  font-size: 14px;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.error-type {
  background: rgba(239, 68, 68, 0.2);
  color: #fca5a5;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
}
```

## 8. 总结

本桌面端部署运维方案文档详细描述了 OfferHelper 桌面端应用的完整部署和运维体系，包括：

### 8.1 部署特色

- **自动化构建**: 完整的 CI/CD 流水线，支持多平台自动构建
- **代码签名**: 支持 macOS 和 Windows 平台的代码签名和公证
- **安全检查**: 集成安全扫描和漏洞检测
- **多渠道分发**: 支持官网、应用商店、包管理器等多种分发方式

### 8.2 运维优势

- **实时监控**: 完整的性能监控和错误追踪系统
- **自动更新**: 智能的增量更新机制
- **使用统计**: 详细的用户行为分析
- **故障诊断**: 快速定位和解决问题的工具链

### 8.3 技术亮点

- **跨平台支持**: Windows、macOS、Linux 三大平台
- **安全可靠**: 多层次的安全防护和数据保护
- **性能优化**: 内存和 CPU 使用监控与优化
- **用户体验**: 无感知的更新和错误恢复机制

### 8.4 运维流程

1. **开发阶段**: 代码质量检查、安全扫描、单元测试
2. **构建阶段**: 自动化构建、代码签名、制品生成
3. **测试阶段**: E2E 测试、性能测试、兼容性测试
4. **发布阶段**: 多渠道分发、版本管理、回滚机制
5. **运维阶段**: 监控告警、性能分析、用户反馈

该部署运维方案确保了桌面端应用能够稳定、安全、高效地为用户提供服务，同时为开发团队提供了完整的运维工具链和监控体系。

## 9. 附录

### 9.1 常用命令

```bash
# 开发环境
npm run dev                    # 启动开发环境
npm run build                  # 构建应用
npm run test                   # 运行测试
npm run lint                   # 代码检查

# 构建分发
npm run dist                   # 构建所有平台
npm run dist:mac              # 构建 macOS 版本
npm run dist:win              # 构建 Windows 版本
npm run dist:linux            # 构建 Linux 版本

# 维护工具
npm run clean                  # 清理构建文件
npm run rebuild               # 重新构建
npm run security-check        # 安全检查
npm run performance-test      # 性能测试
```

### 9.2 环境变量配置

```bash
# 构建环境变量
NODE_ENV=production           # 环境类型
ELECTRON_BUILDER_CACHE_DIR    # 构建缓存目录

# 代码签名
CSC_LINK                      # macOS 证书路径
CSC_KEY_PASSWORD             # macOS 证书密码
WIN_CSC_LINK                 # Windows 证书路径
WIN_CSC_KEY_PASSWORD         # Windows 证书密码

# 发布配置
GH_TOKEN                     # GitHub Token
SENTRY_DSN                   # Sentry DSN
ANALYTICS_KEY                # 分析服务密钥

# 更新服务
UPDATE_SERVER_URL            # 更新服务器地址
AUTO_UPDATE_ENABLED          # 是否启用自动更新
```

### 9.3 故障排查指南

#### 9.3.1 构建失败

```bash
# 清理缓存重新构建
npm run clean
rm -rf node_modules
npm install
npm run build

# 检查依赖版本
npm audit
npm outdated

# 查看详细错误日志
npm run build -- --verbose
```

#### 9.3.2 签名失败

```bash
# 检查证书有效性
security find-identity -v -p codesigning  # macOS
certlm.msc                                 # Windows

# 验证证书配置
echo $CSC_LINK
echo $CSC_KEY_PASSWORD

# 手动签名测试
codesign --verify --verbose dist/mac/OfferHelper.app  # macOS
```

#### 9.3.3 更新失败

```bash
# 检查更新服务器连接
curl -I https://api.offerhelper.com/updates

# 查看更新日志
tail -f ~/Library/Logs/OfferHelper/main.log  # macOS
type %APPDATA%\OfferHelper\logs\main.log     # Windows

# 手动触发更新检查
# 在应用中按 Ctrl+Shift+U
```

### 9.4 性能优化建议

#### 9.4.1 内存优化

- 定期清理未使用的对象引用
- 使用 WeakMap 和 WeakSet 避免内存泄漏
- 限制同时处理的数据量
- 实现对象池复用机制

#### 9.4.2 启动优化

- 延迟加载非关键模块
- 使用预编译的模板和资源
- 优化主进程初始化流程
- 减少同步 I/O 操作

#### 9.4.3 渲染优化

- 使用虚拟滚动处理大列表
- 实现组件懒加载
- 优化 CSS 选择器性能
- 减少不必要的重渲染

### 9.5 安全最佳实践

#### 9.5.1 代码安全

- 定期更新依赖包版本
- 使用 ESLint 安全规则
- 避免使用 eval() 和 innerHTML
- 验证所有用户输入

#### 9.5.2 数据安全

- 加密敏感数据存储
- 使用 HTTPS 进行网络通信
- 实现访问控制和权限管理
- 定期备份重要数据

#### 9.5.3 运行时安全

- 启用内容安全策略 (CSP)
- 禁用不必要的 Node.js 集成
- 使用沙箱模式运行渲染进程
- 定期检查和更新安全配置

该部署运维方案为 OfferHelper 桌面端应用提供了完整的生产环境支持，确保应用能够稳定、安全、高效地为用户提供服务。

# 桌面端部署运维方案

## 1. 部署架构概览

### 1.1 部署流程图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   开发环境       │    │   构建环境       │    │   分发环境       │
│                │    │                │    │                │
│ • 代码开发      │───▶│ • 自动构建      │───▶│ • 应用签名      │
│ • 本地测试      │    │ • 质量检查      │    │ • 版本发布      │
│ • 代码提交      │    │ • 安全扫描      │    │ • 更新推送      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   版本控制       │    │   CI/CD 流水线   │    │   用户设备       │
│                │    │                │    │                │
│ • Git 仓库      │    │ • GitHub Actions│    │ • 自动更新      │
│ • 分支管理      │    │ • 构建缓存      │    │ • 错误上报      │
│ • 代码审查      │    │ • 测试覆盖      │    │ • 使用统计      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术栈选择

```json
{
  "构建工具": {
    "主构建": "Electron Builder",
    "打包": "Webpack 5",
    "代码压缩": "Terser",
    "资源优化": "ImageMin"
  },
  "CI/CD": {
    "平台": "GitHub Actions",
    "缓存": "GitHub Cache",
    "制品存储": "GitHub Releases",
    "通知": "Slack/钉钉"
  },
  "分发渠道": {
    "官方网站": "直接下载",
    "应用商店": "Microsoft Store, Mac App Store",
    "包管理器": "Homebrew, Chocolatey, Snap",
    "企业分发": "内部更新服务器"
  },
  "监控运维": {
    "错误监控": "Sentry",
    "性能监控": "Electron APM",
    "使用统计": "Google Analytics",
    "日志收集": "Winston + LogRocket"
  }
}
```

## 2. 构建配置

### 2.1 Electron Builder 配置

```json
{
  "name": "offerhelper",
  "productName": "OfferHelper",
  "version": "1.0.0",
  "description": "程序员面试AI辅助助手",
  "main": "dist/main.js",
  "homepage": "https://offerhelper.com",
  "author": {
    "name": "OfferHelper Team",
    "email": "support@offerhelper.com"
  },
  "build": {
    "appId": "com.offerhelper.desktop",
    "productName": "OfferHelper",
    "copyright": "Copyright © 2024 OfferHelper Team",
    "directories": {
      "output": "release",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "extraResources": [
      {
        "from": "resources/",
        "to": "resources/",
        "filter": ["**/*"]
      }
    ],
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "build/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        },
        {
          "target": "zip",
          "arch": ["x64", "arm64"]
        }
      ]
    },
    "win": {
      "icon": "build/icon.ico",
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x64"]
        }
      ]
    },
    "linux": {
      "icon": "build/icon.png",
      "target": [
        {
          "target": "AppImage",
          "arch": ["x64"]
        },
        {
          "target": "deb",
          "arch": ["x64"]
        },
        {
          "target": "rpm",
          "arch": ["x64"]
        }
      ]
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "installerIcon": "build/icon.ico",
      "uninstallerIcon": "build/icon.ico",
      "installerHeaderIcon": "build/icon.ico",
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "shortcutName": "OfferHelper"
    },
    "dmg": {
      "title": "OfferHelper ${version}",
      "icon": "build/icon.icns",
      "background": "build/dmg-background.png",
      "contents": [
        {
          "x": 130,
          "y": 220,
          "type": "file"
        },
        {
          "x": 410,
          "y": 220,
          "type": "link",
          "path": "/Applications"
        }
      ]
    },
    "publish": [
      {
        "provider": "github",
        "owner": "offerhelper",
        "repo": "desktop"
      }
    ]
  }
}
```

### 2.2 构建脚本

```json
{
  "scripts": {
    "dev": "concurrently \"npm run dev:main\" \"npm run dev:renderer\"",
    "dev:main": "webpack --config webpack.main.config.js --mode development --watch",
    "dev:renderer": "webpack serve --config webpack.renderer.config.js --mode development",
    "build": "npm run build:main && npm run build:renderer",
    "build:main": "webpack --config webpack.main.config.js --mode production",
    "build:renderer": "webpack --config webpack.renderer.config.js --mode production",
    "dist": "npm run build && electron-builder",
    "dist:mac": "npm run build && electron-builder --mac",
    "dist:win": "npm run build && electron-builder --win",
    "dist:linux": "npm run build && electron-builder --linux",
    "pack": "npm run build && electron-builder --dir",
    "postinstall": "electron-builder install-app-deps",
    "test": "jest",
    "test:e2e": "playwright test",
    "lint": "eslint src --ext .ts,.tsx",
    "lint:fix": "eslint src --ext .ts,.tsx --fix",
    "type-check": "tsc --noEmit",
    "clean": "rimraf dist release",
    "rebuild": "npm run clean && npm install && npm run build"
  }
}
```

### 2.3 Webpack 配置

```javascript
// webpack.main.config.js
const path = require('path');

module.exports = {
  target: 'electron-main',
  entry: './src/main/main.ts',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'main.js'
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader',
        exclude: /node_modules/
      }
    ]
  },
  resolve: {
    extensions: ['.ts', '.js']
  },
  node: {
    __dirname: false,
    __filename: false
  },
  externals: {
    'better-sqlite3': 'commonjs better-sqlite3',
    'ffi-napi': 'commonjs ffi-napi'
  }
};

// webpack.renderer.config.js
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');

module.exports = (env, argv) => {
  const isProduction = argv.mode === 'production';

  return {
    target: 'electron-renderer',
    entry: './src/renderer/index.tsx',
    output: {
      path: path.resolve(__dirname, 'dist'),
      filename: 'renderer.js'
    },
    module: {
      rules: [
        {
          test: /\.tsx?$/,
          use: 'ts-loader',
          exclude: /node_modules/
        },
        {
          test: /\.css$/,
          use: [
            isProduction ? MiniCssExtractPlugin.loader : 'style-loader',
            'css-loader',
            'postcss-loader'
          ]
        },
        {
          test: /\.(png|jpg|gif|svg)$/,
          type: 'asset/resource'
        }
      ]
    },
    resolve: {
      extensions: ['.tsx', '.ts', '.js'],
      alias: {
        '@': path.resolve(__dirname, 'src/renderer')
      }
    },
    plugins: [
      new HtmlWebpackPlugin({
        template: './src/renderer/index.html'
      }),
      ...(isProduction ? [new MiniCssExtractPlugin()] : [])
    ],
    devServer: {
      port: 3000,
      hot: true
    }
  };
};
```

## 3. CI/CD 流水线

### 3.1 GitHub Actions 配置

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm test

      - name: Run E2E tests
        run: npm run test:e2e

  build:
    needs: test
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build distributables
        run: npm run dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-${{ matrix.os }}
          path: release/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-macos-latest/**/*
            dist-windows-latest/**/*
            dist-ubuntu-latest/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 3.2 代码质量检查

```yaml
# .github/workflows/quality.yml
name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format=json --output-file=eslint-report.json
        continue-on-error: true

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,css,md}"

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Run dependency check
        run: npx depcheck

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

### 3.3 自动化测试

```yaml
# .github/workflows/test.yml
name: Automated Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- --coverage --watchAll=false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  e2e-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Install Playwright
        run: npx playwright install

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report-${{ matrix.os }}
          path: playwright-report/
```

## 4. 代码签名与安全

### 4.1 macOS 代码签名

```xml
<!-- build/entitlements.mac.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>com.apple.security.cs.allow-jit</key>
  <true/>
  <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
  <true/>
  <key>com.apple.security.cs.disable-library-validation</key>
  <true/>
  <key>com.apple.security.device.microphone</key>
  <true/>
  <key>com.apple.security.device.camera</key>
  <false/>
  <key>com.apple.security.network.client</key>
  <true/>
  <key>com.apple.security.network.server</key>
  <false/>
  <key>com.apple.security.files.user-selected.read-write</key>
  <true/>
</dict>
</plist>
```

```bash
# 签名脚本
#!/bin/bash

# 设置环境变量
export CSC_LINK="path/to/certificate.p12"
export CSC_KEY_PASSWORD="certificate_password"
export APPLE_ID="developer@example.com"
export APPLE_ID_PASSWORD="app_specific_password"

# 构建并签名
npm run dist:mac

# 公证应用
xcrun altool --notarize-app \
  --primary-bundle-id "com.offerhelper.desktop" \
  --username "$APPLE_ID" \
  --password "$APPLE_ID_PASSWORD" \
  --file "release/OfferHelper-1.0.0.dmg"
```

### 4.2 Windows 代码签名

```javascript
// 签名配置
const { execSync } = require('child_process');
const path = require('path');

function signWindows() {
  const signtool = 'C:\\Program Files (x86)\\Windows Kits\\10\\bin\\10.0.19041.0\\x64\\signtool.exe';
  const certificate = process.env.WIN_CSC_LINK;
  const password = process.env.WIN_CSC_KEY_PASSWORD;

  const files = [
    'release/OfferHelper Setup 1.0.0.exe',
    'release/OfferHelper 1.0.0.exe'
  ];

  files.forEach(file => {
    if (require('fs').existsSync(file)) {
      const command = `"${signtool}" sign /f "${certificate}" /p "${password}" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "${file}"`;
      execSync(command, { stdio: 'inherit' });
      console.log(`已签名: ${file}`);
    }
  });
}

module.exports = { signWindows };
```

### 4.3 安全检查脚本

```javascript
// scripts/security-check.js
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

class SecurityChecker {
  constructor() {
    this.vulnerabilities = [];
    this.securityRules = [
      this.checkHardcodedSecrets,
      this.checkInsecureProtocols,
      this.checkDangerousPermissions,
      this.checkOutdatedDependencies
    ];
  }

  async runAllChecks() {
    console.log('🔍 开始安全检查...');

    for (const rule of this.securityRules) {
      await rule.call(this);
    }

    this.generateReport();
  }

  checkHardcodedSecrets() {
    const patterns = [
      /api[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /secret[_-]?key\s*[:=]\s*['"][^'"]+['"]/gi,
      /password\s*[:=]\s*['"][^'"]+['"]/gi,
      /token\s*[:=]\s*['"][^'"]+['"]/gi
    ];

    this.scanFiles('src', patterns, '硬编码密钥');
  }

  checkInsecureProtocols() {
    const patterns = [
      /http:\/\/(?!localhost|127\.0\.0\.1)/gi,
      /ftp:\/\//gi
    ];

    this.scanFiles('src', patterns, '不安全协议');
  }

  checkDangerousPermissions() {
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const dangerousPerms = [
      'nodeIntegration: true',
      'contextIsolation: false',
      'webSecurity: false'
    ];

    // 检查是否有危险的 Electron 配置
    this.scanFiles('src', dangerousPerms.map(p => new RegExp(p, 'gi')), '危险权限');
  }

  async checkOutdatedDependencies() {
    try {
      const { execSync } = require('child_process');
      const auditResult = execSync('npm audit --json', { encoding: 'utf8' });
      const audit = JSON.parse(auditResult);

      if (audit.metadata.vulnerabilities.total > 0) {
        this.vulnerabilities.push({
          type: '依赖漏洞',
          count: audit.metadata.vulnerabilities.total,
          details: audit.advisories
        });
      }
    } catch (error) {
      console.warn('依赖检查失败:', error.message);
    }
  }

  scanFiles(dir, patterns, type) {
    const files = this.getAllFiles(dir);

    files.forEach(file => {
      const content = fs.readFileSync(file, 'utf8');

      patterns.forEach(pattern => {
        const matches = content.match(pattern);
        if (matches) {
          this.vulnerabilities.push({
            type,
            file,
            matches: matches.length,
            details: matches
          });
        }
      });
    });
  }

  getAllFiles(dir) {
    let files = [];
    const items = fs.readdirSync(dir);

    items.forEach(item => {
      const fullPath = path.join(dir, item);
      const stat = fs.statSync(fullPath);

      if (stat.isDirectory() && !item.startsWith('.') && item !== 'node_modules') {
        files = files.concat(this.getAllFiles(fullPath));
      } else if (stat.isFile() && /\.(js|ts|tsx|jsx)$/.test(item)) {
        files.push(fullPath);
      }
    });

    return files;
  }

  generateReport() {
    console.log('\n📊 安全检查报告');
    console.log('='.repeat(50));

    if (this.vulnerabilities.length === 0) {
      console.log('✅ 未发现安全问题');
      return;
    }

    this.vulnerabilities.forEach((vuln, index) => {
      console.log(`\n${index + 1}. ${vuln.type}`);
      if (vuln.file) {
        console.log(`   文件: ${vuln.file}`);
        console.log(`   匹配: ${vuln.matches} 个`);
      }
      if (vuln.count) {
        console.log(`   数量: ${vuln.count}`);
      }
    });

    console.log(`\n⚠️  总计发现 ${this.vulnerabilities.length} 个安全问题`);

    // 如果有高危漏洞，退出构建
    const criticalIssues = this.vulnerabilities.filter(v =>
      v.type === '硬编码密钥' || v.type === '危险权限'
    );

    if (criticalIssues.length > 0) {
      console.error('❌ 发现高危安全问题，构建终止');
      process.exit(1);
    }
  }
}

// 运行安全检查
if (require.main === module) {
  const checker = new SecurityChecker();
  checker.runAllChecks();
}

module.exports = SecurityChecker;
```

## 5. 自动更新系统

### 5.1 更新服务器配置

```javascript
// update-server/server.js
const express = require('express');
const semver = require('semver');
const app = express();

// 版本信息存储
const versions = {
  'darwin': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-x64.zip',
      signature: 'signature_hash_here'
    },
    'arm64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-mac-arm64.zip',
      signature: 'signature_hash_here'
    }
  },
  'win32': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-win-x64.exe',
      signature: 'signature_hash_here'
    }
  },
  'linux': {
    'x64': {
      version: '1.0.0',
      url: 'https://releases.offerhelper.com/v1.0.0/OfferHelper-1.0.0-linux-x64.AppImage',
      signature: 'signature_hash_here'
    }
  }
};

// 检查更新接口
app.get('/update/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  const platformVersions = versions[platform];
  if (!platformVersions) {
    return res.status(404).json({ error: 'Platform not supported' });
  }

  const archVersion = platformVersions[arch];
  if (!archVersion) {
    return res.status(404).json({ error: 'Architecture not supported' });
  }

  // 比较版本
  if (semver.gt(archVersion.version, version)) {
    res.json({
      version: archVersion.version,
      url: archVersion.url,
      signature: archVersion.signature,
      releaseNotes: `更新到版本 ${archVersion.version}`
    });
  } else {
    res.status(204).send(); // 无更新
  }
});

// 下载统计
app.get('/download/:platform/:arch/:version', (req, res) => {
  const { platform, arch, version } = req.params;

  // 记录下载统计
  console.log(`下载: ${platform}-${arch}-${version}`);

  // 重定向到实际下载地址
  const platformVersions = versions[platform];
  const archVersion = platformVersions?.[arch];

  if (archVersion && archVersion.version === version) {
    res.redirect(archVersion.url);
  } else {
    res.status(404).json({ error: 'Version not found' });
  }
});

app.listen(3001, () => {
  console.log('更新服务器运行在端口 3001');
});
```

### 5.2 客户端更新逻辑

```typescript
// src/main/updater.ts
import { autoUpdater } from 'electron-updater';
import { dialog, BrowserWindow } from 'electron';
import log from 'electron-log';

class AppUpdater {
  private mainWindow: BrowserWindow;
  private updateCheckInterval: NodeJS.Timeout | null = null;

  constructor(mainWindow: BrowserWindow) {
    this.mainWindow = mainWindow;
    this.setupUpdater();
  }

  private setupUpdater(): void {
    // 配置更新服务器
    autoUpdater.setFeedURL({
      provider: 'generic',
      url: 'https://api.offerhelper.com/updates'
    });

    // 配置日志
    autoUpdater.logger = log;
    (autoUpdater.logger as any).transports.file.level = 'info';

    // 事件监听
    autoUpdater.on('checking-for-update', () => {
      log.info('检查更新中...');
      this.sendStatusToWindow('checking-for-update');
    });

    autoUpdater.on('update-available', (info) => {
      log.info('发现新版本:', info.version);
      this.sendStatusToWindow('update-available', info);
      this.showUpdateDialog(info);
    });

    autoUpdater.on('update-not-available', (info) => {
      log.info('当前已是最新版本');
      this.sendStatusToWindow('update-not-available', info);
    });

    autoUpdater.on('error', (err) => {
      log.error('更新错误:', err);
      this.sendStatusToWindow('update-error', err);
    });

    autoUpdater.on('download-progress', (progressObj) => {
      let logMessage = `下载速度: ${progressObj.bytesPerSecond}`;
      logMessage += ` - 已下载 ${progressObj.percent}%`;
      logMessage += ` (${progressObj.transferred}/${progressObj.total})`;

      log.info(logMessage);
      this.sendStatusToWindow('download-progress', progressObj);
    });

    autoUpdater.on('update-downloaded', (info) => {
      log.info('更新下载完成');
      this.sendStatusToWindow('update-downloaded', info);
      this.showRestartDialog();
    });
  }

  public checkForUpdates(): void {
    autoUpdater.checkForUpdatesAndNotify();
  }

  public startAutoCheck(): void {
    // 每小时检查一次更新
    this.updateCheckInterval = setInterval(() => {
      this.checkForUpdates();
    }, 60 * 60 * 1000);

    // 启动时检查
    setTimeout(() => {
      this.checkForUpdates();
    }, 5000);
  }

  public stopAutoCheck(): void {
    if (this.updateCheckInterval) {
      clearInterval(this.updateCheckInterval);
      this.updateCheckInterval = null;
    }
  }

  private sendStatusToWindow(event: string, data?: any): void {
    if (this.mainWindow && !this.mainWindow.isDestroyed()) {
      this.mainWindow.webContents.send('updater-message', { event, data });
    }
  }

  private showUpdateDialog(info: any): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['立即更新', '稍后提醒', '跳过此版本'],
      defaultId: 0,
      title: '发现新版本',
      message: `发现新版本 ${info.version}`,
      detail: '是否立即下载并安装更新？'
    });

    switch (response) {
      case 0: // 立即更新
        autoUpdater.downloadUpdate();
        break;
      case 1: // 稍后提醒
        // 1小时后再次提醒
        setTimeout(() => {
          this.showUpdateDialog(info);
        }, 60 * 60 * 1000);
        break;
      case 2: // 跳过此版本
        // 记录跳过的版本
        this.skipVersion(info.version);
        break;
    }
  }

  private showRestartDialog(): void {
    const response = dialog.showMessageBoxSync(this.mainWindow, {
      type: 'info',
      buttons: ['立即重启', '稍后重启'],
      defaultId: 0,
      title: '更新已下载',
      message: '更新已下载完成',
      detail: '需要重启应用以完成更新。'
    });

    if (response === 0) {
      autoUpdater.quitAndInstall();
    }
  }

  private skipVersion(version: string): void {
    // 将跳过的版本保存到本地存储
    const { app } = require('electron');
    const fs = require('fs');
    const path = require('path');

    const configPath = path.join(app.getPath('userData'), 'update-config.json');
    let config = {};

    try {
      if (fs.existsSync(configPath)) {
        config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
      }
    } catch (error) {
      log.error('读取更新配置失败:', error);
    }

    config.skippedVersions = config.skippedVersions || [];
    if (!config.skippedVersions.includes(version)) {
      config.skippedVersions.push(version);
    }

    try {
      fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
    } catch (error) {
      log.error('保存更新配置失败:', error);
    }
  }
}

export default AppUpdater;
```

### 5.3 渲染进程更新界面

```tsx
// src/renderer/components/UpdateNotification.tsx
import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface UpdateInfo {
  version: string;
  releaseNotes?: string;
}

interface UpdateProgress {
  percent: number;
  bytesPerSecond: number;
  transferred: number;
  total: number;
}

const UpdateNotification: React.FC = () => {
  const [updateState, setUpdateState] = useState<string>('');
  const [updateInfo, setUpdateInfo] = useState<UpdateInfo | null>(null);
  const [downloadProgress, setDownloadProgress] = useState<UpdateProgress | null>(null);
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    // 监听更新事件
    const handleUpdaterMessage = (event: any, { event: updateEvent, data }: any) => {
      setUpdateState(updateEvent);

      switch (updateEvent) {
        case 'update-available':
          setUpdateInfo(data);
          setIsVisible(true);
          break;
        case 'download-progress':
          setDownloadProgress(data);
          break;
        case 'update-downloaded':
          setDownloadProgress(null);
          break;
        case 'update-not-available':
        case 'update-error':
          setTimeout(() => setIsVisible(false), 3000);
          break;
      }
    };

    window.electron?.ipcRenderer.on('updater-message', handleUpdaterMessage);

    return () => {
      window.electron?.ipcRenderer.removeListener('updater-message', handleUpdaterMessage);
    };
  }, []);

  const getStatusText = () => {
    switch (updateState) {
      case 'checking-for-update':
        return '检查更新中...';
      case 'update-available':
        return `发现新版本 ${updateInfo?.version}`;
# 桌面端部署运维方案

## 1. 部署架构概览

### 1.1 部署流程图

```

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   开发环境       │    │   构建环境       │    │   分发环境       │
│                │    │                │    │                │
│ • 代码开发      │───▶│ • 自动构建      │───▶│ • 应用签名      │
│ • 本地测试      │    │ • 质量检查      │    │ • 版本发布      │
│ • 代码提交      │    │ • 安全扫描      │    │ • 更新推送      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   版本控制       │    │   CI/CD 流水线   │    │   用户设备       │
│                │    │                │    │                │
│ • Git 仓库      │    │ • GitHub Actions│    │ • 自动更新      │
│ • 分支管理      │    │ • 构建缓存      │    │ • 错误上报      │
│ • 代码审查      │    │ • 测试覆盖      │    │ • 使用统计      │
└─────────────────┘    └─────────────────┘    └─────────────────┘

```

### 1.2 技术栈选择

```json
{
  "构建工具": {
    "主构建": "Electron Builder",
    "打包": "Webpack 5",
    "代码压缩": "Terser",
    "资源优化": "ImageMin"
  },
  "CI/CD": {
    "平台": "GitHub Actions",
    "缓存": "GitHub Cache",
    "制品存储": "GitHub Releases",
    "通知": "Slack/钉钉"
  },
  "分发渠道": {
    "官方网站": "直接下载",
    "应用商店": "Microsoft Store, Mac App Store",
    "包管理器": "Homebrew, Chocolatey, Snap",
    "企业分发": "内部更新服务器"
  },
  "监控运维": {
    "错误监控": "Sentry",
    "性能监控": "Electron APM",
    "使用统计": "Google Analytics",
    "日志收集": "Winston + LogRocket"
  }
}
```

## 2. 构建配置

### 2.1 Electron Builder 配置

```json
{
  "name": "offerhelper",
  "productName": "OfferHelper",
  "version": "1.0.0",
  "description": "程序员面试AI辅助助手",
  "main": "dist/main.js",
  "homepage": "https://offerhelper.com",
  "author": {
    "name": "OfferHelper Team",
    "email": "support@offerhelper.com"
  },
  "build": {
    "appId": "com.offerhelper.desktop",
    "productName": "OfferHelper",
    "copyright": "Copyright © 2024 OfferHelper Team",
    "directories": {
      "output": "release",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "package.json"
    ],
    "extraResources": [
      {
        "from": "resources/",
        "to": "resources/",
        "filter": ["**/*"]
      }
    ],
    "mac": {
      "category": "public.app-category.productivity",
      "icon": "build/icon.icns",
      "hardenedRuntime": true,
      "gatekeeperAssess": false,
      "entitlements": "build/entitlements.mac.plist",
      "entitlementsInherit": "build/entitlements.mac.plist",
      "target": [
        {
          "target": "dmg",
          "arch": ["x64", "arm64"]
        },
        {
          "target": "zip",
          "arch": ["x64", "arm64"]
        }
      ]
    },
    "win": {
      "icon": "build/icon.ico",
      "target": [
        {
          "target": "nsis",
          "arch": ["x64", "ia32"]
        },
        {
          "target": "portable",
          "arch": ["x
