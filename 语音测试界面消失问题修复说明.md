# OfferHelper语音测试界面消失问题修复

## 🔍 问题现象
用户反馈：点击"开始识别"后界面就消失了，不显示任何内容，应用变成白屏状态。

## 🕵️ 问题分析

经过深入调试发现，这个问题的根本原因是 **事件系统不匹配**：

### 问题细节：
1. `SpeechService.ts` 中原本有自己的 `SimpleEventBus` 实现，该实现会同时发射：
   - EventBus 自定义事件 
   - DOM 自定义事件（如 speechStart, speechEnd 等）

2. 之前的修复中，我们移除了重复的 `SimpleEventBus`，统一使用 `src/shared/utils/EventBus.ts`

3. 但是共享的 `EventBus` 只发射 EventBus 事件，不发射 DOM 事件

4. 而 `SpeechMonitor.tsx` 组件监听的是 DOM 事件：
   ```javascript
   document.addEventListener('speechStart', handleStart, eventOptions);
   document.addEventListener('speechEnd', handleEnd, eventOptions);
   // 等等...
   ```

5. 因此当 `EventBus.emit('speech:started')` 发射后，`SpeechMonitor` 收不到对应的DOM事件，导致界面状态异常

## 🔧 解决方案

修改共享的 `EventBus.ts`，让它同时发射 DOM 事件以保持兼容性：

```typescript
static emit(event: string, data?: any): void {
  console.log(`EventBus: 发射事件 ${event}`, data);
  
  // 发射自定义事件系统
  if (this.listeners[event]) {
    this.listeners[event].forEach(callback => {
      try {
        callback(data);
      } catch (error) {
        console.error(`EventBus: 事件处理器执行失败 [${event}]:`, error);
      }
    });
  }
  
  // 同时发射DOM事件以兼容现有组件
  if (typeof window !== 'undefined' && typeof document !== 'undefined') {
    try {
      // 将语音事件映射到DOM事件名称
      const domEventMap: { [key: string]: string } = {
        'speech:started': 'speechStart',
        'speech:ended': 'speechEnd', 
        'speech:error': 'speechError',
        'speech:result': 'speechTranscript',
        'speech:interim': 'speechInterimTranscript'
      };
      
      const domEventName = domEventMap[event] || event;
      const customEvent = new CustomEvent(domEventName, { detail: data });
      document.dispatchEvent(customEvent);
      console.log(`EventBus: DOM事件已发射 ${domEventName}`);
    } catch (error) {
      console.error(`EventBus: DOM事件发射失败 [${event}]:`, error);
    }
  }
}
```

## ✅ 修复结果

现在 EventBus 会同时发射：
1. EventBus 自定义事件（给其他使用 EventBus.on() 的组件）
2. DOM 自定义事件（给使用 document.addEventListener() 的组件如 SpeechMonitor）

这样就解决了事件系统不匹配的问题，语音测试界面应该能正常显示和响应了。

## 📝 测试建议
1. 重新启动应用
2. 点击设置 → 语音测试
3. 点击"开始识别"
4. 观察界面是否正常显示和响应事件

界面应该不再消失，能正常显示语音识别状态和结果。