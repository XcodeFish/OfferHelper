# 腾讯云实时语音识别（WebSocket）接口文档

## 一、接口描述

- **功能**：采用WebSocket协议，对实时音频流进行识别，同步返回识别结果，实现“边说边出文字”效果。
- **前置准备**：需开通语音识别服务，生成AppID、SecretID、SecretKey用于接口鉴权。

## 二、接口要求

| 内容         | 说明                                                                 |
|--------------|----------------------------------------------------------------------|
| 语言种类     | 支持中文普通话、粤语、英语等多语言及多方言（如上海话、四川话等），通过`engine_model_type`参数设置。 |
| 支持行业     | 通用、金融、游戏、教育、医疗                                         |
| 音频属性     | 采样率：16000Hz或8000Hz；采样精度：16bits；声道：单声道（mono）       |
| 音频格式     | pcm、wav、opus、speex、silk、mp3、m4a、aac                           |
| 请求协议     | wss协议                                                              |
| 请求地址     | wss://asr.cloud.tencent.com/asr/v2/`<appid>`?{请求参数}              |
| 接口鉴权     | 签名鉴权机制（详见“signature签名生成”）                              |
| 响应格式     | JSON格式                                                             |
| 数据发送     | 建议每40ms发送40ms时长的数据包（1:1实时率），超速率或间隔超6秒可能导致连接断开。 |
| 并发限制     | 默认单账号200路，可付费提升                                         |

## 三、接口调用流程

分为**握手阶段**和**识别阶段**，均返回JSON格式的text message。

### 通用响应字段

| 字段名      | 类型    | 描述                                                             |
|-------------|---------|------------------------------------------------------------------|
| code        | Integer | 状态码（0为正常，非0为错误）                                     |
| message     | String  | 错误说明（错误时返回）                                           |
| voice_id    | String  | 音频流全局唯一标识（用户生成，每次连接需重新生成）                |
| message_id  | String  | 消息唯一ID                                                       |
| result      | Result  | 识别结果（识别阶段返回）                                         |
| final       | Integer | 1表示音频流识别结束（识别阶段最终返回）                          |

### 识别结果Result结构体

| 字段名          | 类型       | 描述                                                                 |
|-----------------|------------|----------------------------------------------------------------------|
| slice_type      | Integer    | 识别结果类型：0（一段话开始）、1（识别中，结果可能变化）、2（识别结束，结果稳定） |
| index           | Integer    | 结果在音频流中的序号（从0递增）                                       |
| start_time      | Integer    | 起始时间（毫秒）                                                     |
| end_time        | Integer    | 结束时间（毫秒）                                                     |
| voice_text_str  | String     | 识别文本（UTF8编码）                                                 |
| word_size       | Integer    | 词结果个数                                                           |
| word_list       | Word Array | 词列表（包含word、start_time、end_time、stable_flag（0可变/1稳定））   |

## 四、握手阶段

### 请求格式

客户端发起WebSocket连接，URL参数需urlencode，格式：`wss://asr.cloud.tencent.com/asr/v2/<appid>?key1=value1&key2=value2...`

### 请求参数说明

| 参数名称           | 必填 | 类型    | 描述                                                                 |
|--------------------|------|---------|----------------------------------------------------------------------|
| secretid           | 是   | String  | 腾讯云SecretId（从API密钥管理获取）                                 |
| timestamp          | 是   | Integer | 当前UNIX时间戳（秒），与服务器时间差过大会导致签名过期               |
| expired            | 是   | Integer | 签名过期时间戳（秒），需大于timestamp且差值<90天                     |
| nonce              | 是   | Integer | 随机正整数（最长10位）                                               |
| engine_model_type  | 是   | String  | 引擎模型类型（分电话/非电话场景，如8k_zh、16k_zh_large等）           |
| voice_id           | 是   | String  | 音频流唯一标识（推荐UUID，最长128位）                                |
| voice_format       | 否   | Int     | 音频编码格式（默认4：speex，可选1:pcm、10:opus等）                   |
| needvad            | 否   | Integer | 是否开启人声检测（0关闭/1开启，默认0，音频超60秒建议开启）           |
| hotword_id         | 否   | String  | 热词表ID（需预先创建）                                               |
| customization_id   | 否   | String  | 自学习模型ID                                                         |
| filter_dirty       | 否   | Integer | 过滤脏词（0不过滤/1过滤/2替换为*，默认0，仅支持中文普通话）           |
| filter_modal       | 否   | Integer | 过滤语气词（0不过滤/1部分/2严格，默认0，仅支持中文普通话）           |
| filter_punc        | 否   | Integer | 过滤句末句号（0不过滤/1过滤，默认0，仅支持中文普通话）               |
| filter_empty_result| 否   | Integer | 是否回调空结果（0回调/1不回调，默认1，需0和2配对返回时设为0）         |
| convert_num_mode   | 否   | Integer | 数字转换（0中文/1智能转阿拉伯/3数学转换，默认1，仅支持中文普通话）   |
| word_info          | 否   | Int     | 词级别时间戳（0不显示/1显示不含标点/2显示含标点，默认0）             |
| vad_silence_time   | 否   | Integer | 静音断句阈值（240-2000ms，默认1000，需配合needvad=1）                |
| max_speak_time     | 否   | Integer | 强制断句时间（5000-90000ms，默认60000，连续说话时触发）              |
| signature          | 是   | String  | 接口签名（详见签名生成）                                             |
| hotword_list       | 否   | String  | 临时热词表（格式：“热词|权重,...”，权重1-11或100，优先级高于hotword_id） |
| input_sample_rate  | 否   | Integer | 8k PCM音频升采样到16k（仅支持8000）                                  |
| emotion_recognition| 否   | Integer | 情绪识别（0关闭/1开启不显示标签/2开启显示标签，增值服务）             |
| replace_text_id    | 否   | String  | 替换词汇表ID（强制替换极端情况词组）                                 |

### signature签名生成

1. 除signature外的参数按字典序排序，拼接URL（不含wss://）作为签名原文；
2. 用SecretKey对原文进行HmacSha1加密，再base64编码；
3. 对签名值urlencode后拼接至请求URL。

### 握手响应

- 成功：`{"code":0,"message":"success","voice_id":"xxx"}`
- 失败：返回非0code及错误信息，断开连接。

## 五、识别阶段

### 上传数据

- 发送binary message（音频二进制数据），建议按1:1实时率发送；
- 音频结束后发送text message：`{"type": "end"}`通知服务器。

### 接收结果

- 实时返回识别结果（含result字段）；
- 最终返回`final=1`的消息并断开连接。

## 六、Opus音频流封装说明

每帧数据格式：

| OpusHead（4字节） | 帧数据长度（2字节） | Opus压缩数据 |
|-------------------|---------------------|--------------|
| "opus"            | len                 | 对应长度的opus数据 |

## 七、错误码

| 错误码 | 说明                                                             |
|--------|------------------------------------------------------------------|
| 4000   | 音频发送过多（1秒内最多发送3秒数据）                             |
| 4001   | 参数不合法                                                       |
| 4002   | 鉴权失败                                                         |
| 4003   | 未开通语音识别服务                                               |
| 4004   | 资源包耗尽                                                       |
| 4005   | 账户欠费                                                         |
| 4006   | 并发超限                                                         |
| 4007   | 音频解码失败（格式与参数不一致）                                 |
| 4008   | 客户端超过15秒未发送数据                                         |
| 4009   | 客户端连接断开                                                   |
| 4010   | 上传未知文本消息                                                 |
| 5000-5002 | 服务器偶发错误（需重新发起识别）                                 |
| 6001   | 境外调用（需开通国际站服务）                                     |

## 八、开发者资源

- **SDK**：支持Go、Java、C++、Python、JS、C#等语言；
- **示例**：提供各语言调用示例（详见官网链接）。

# 补充：请求响应、上传数据、接收消息详细说明

## 一、请求响应（握手阶段）

- **触发时机**：客户端发起WebSocket连接后，服务端进行签名校验并返回结果。
- **成功响应**：

  ```json
  {
    "code": 0,
    "message": "success",
    "voice_id": "RnKu9FODFHK5FPpsrN"  // 客户端传入的音频流唯一标识
  }
  ```

  表示握手成功，可进入识别阶段。

- **失败响应**：
  返回非0状态码及错误详情，例如：

  ```json
  {
    "code": 4002,
    "message": "鉴权失败",
    "voice_id": "xxx"
  }
  ```

  服务端会主动断开连接，需排查参数（如签名、SecretId等）后重新发起连接。

## 二、上传数据（识别阶段）

- **数据类型**：二进制消息（binary message），内容为音频流原始二进制数据。
- **发送要求**：
  - 建议按**1:1实时率**发送（如每40ms发送40ms时长的音频），对应PCM格式：
    - 8k采样率：每次发送640字节
    - 16k采样率：每次发送1280字节
  - 禁止过快发送（1秒内发送超过3秒音频）或间隔过久（超过6秒未发送），否则服务端会返回错误并断开连接。
- **结束标识**：音频流上传完成后，需发送文本消息（text message）通知服务端：

  ```json
  {"type": "end"}
  ```

## 三、接收消息（识别阶段）

- **消息类型**：文本消息（text message），JSON格式，包含实时识别结果。
- **内容说明**：
  1. **识别中消息**（多次返回，非最终结果）：

     ```json
     {
       "code": 0,
       "message": "success",
       "voice_id": "RnKu9FODFHK5FPpsrN",
       "message_id": "RnKu9FODFHK5FPpsrN_11_0",
       "result": {
         "slice_type": 1,  // 1表示识别中，结果可能变化
         "index": 0,
         "start_time": 0,
         "end_time": 1240,
         "voice_text_str": "实时",
         "word_size": 0,
         "word_list": []
       }
     }
     ```

  2. **段落结束消息**（单段识别完成）：

     ```json
     {
       "code": 0,
       "message": "success",
       "voice_id": "RnKu9FODFHK5FPpsrN",
       "message_id": "RnKu9FODFHK5FPpsrN_33_0",
       "result": {
         "slice_type": 2,  // 2表示结果稳定，不再变化
         "index": 0,
         "start_time": 0,
         "end_time": 2840,
         "voice_text_str": "实时语音识别",
         "word_size": 0,
         "word_list": []
       }
     }
     ```

  3. **全部结束消息**（整个音频流识别完成）：

     ```json
     {
       "code": 0,
       "message": "success",
       "voice_id": "CzhjnqBkv8lk5pRUxhpX",
       "message_id": "CzhjnqBkv8lk5pRUxhpX_241",
       "final": 1  // 1表示全部结束
     }
     ```

     服务端发送此消息后会断开连接。

  4. **错误消息**（识别过程中出错）：

     ```json
     {
       "code": 4008,
       "message": "后台识别服务器音频分片等待超时",
       "voice_id": "CzhjnqBkv8lk5pRUxhpX",
       "message_id": "CzhjnqBkv8lk5pRUxhpX_241"
     }
     ```

     服务端会断开连接，需根据错误码排查问题（如网络中断、音频格式错误等）。
