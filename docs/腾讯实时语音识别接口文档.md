# 腾讯云实时语音识别（WebSocket协议）接口文档（含业务流程图）

## 一、接口基本信息

- **功能**：基于WebSocket协议，对实时音频流进行实时识别，同步返回识别结果（“边说边出文字”）。
- **前置条件**：需开通语音识别服务，获取AppID、SecretID、SecretKey用于鉴权。
- **协议**：wss（WebSocket加密协议）。
- **请求地址**：`wss://asr.cloud.tencent.com/asr/v2/<appid>?{请求参数}`（`<appid>`替换为实际AppID，参数需URL编码）。
- **音频要求**：
  - 采样率：16000Hz或8000Hz（需与引擎模型匹配）。
  - 采样精度：16bits。
  - 声道：单声道（mono）。
  - 格式：pcm、wav、opus、speex、silk、mp3、m4a、aac。
- **数据发送规范**：建议按1:1实时率发送（如每40ms发送40ms音频），1秒内发送音频不超过3秒，间隔不超过6秒（否则可能断开连接）。
- **并发限制**：默认单账号200路，可付费提升。

## 二、业务流程图

```
┌───────────────┐                  ┌───────────────┐
│    客户端     │                  │   腾讯云服务端 │
└───────┬───────┘                  └───────┬───────┘
        │                                  │
        │  1. 生成签名（signature）         │
        │  （基于secretid、timestamp等参数） │
        │                                  │
        │  2. 发起WebSocket连接请求         │
        │  （wss://asr.cloud.tencent.com/...） │
        ├─────────────────────────────────>│
        │                                  │
        │  3. 服务端校验签名                │
        │  （成功返回code=0，失败返回错误码） │
        │<─────────────────────────────────┤
        │                                  │
        │  4. 握手成功，进入识别阶段         │
        │  （持续上传音频二进制数据）        │
        ├─────────────────────────────────>│
        │                                  │
        │  5. 服务端实时返回识别结果         │
        │  （含中间结果和最终结果）          │
        │<─────────────────────────────────┤
        │                                  │
        │  6. 音频上传完成，发送结束标识     │
        │  （{"type": "end"}）              │
        ├─────────────────────────────────>│
        │                                  │
        │  7. 服务端返回最终结果（final=1）  │
        │  并断开连接                       │
        │<─────────────────────────────────┤
```

## 三、接口调用流程（详情）

### 1. 握手阶段（建立连接）

#### 请求参数（URL参数）

| 参数名称              | 必填 | 类型    | 描述                                                                 |
|-----------------------|------|---------|----------------------------------------------------------------------|
| secretid              | 是   | String  | 腾讯云SecretId（从API密钥管理获取）。                               |
| timestamp             | 是   | Integer | 当前UNIX时间戳（秒），与服务器时间差过大会导致签名过期。             |
| expired               | 是   | Integer | 签名过期时间戳（秒），需大于timestamp，且差值＜90天。                |
| nonce                 | 是   | Integer | 随机正整数（最长10位），用于防重放。                                 |
| engine_model_type     | 是   | String  | 引擎模型类型（区分电话/非电话场景）：<br>- 电话场景：8k_zh（中文）、8k_en（英文）等；<br>- 非电话场景：16k_zh（中文）、16k_zh_large（中文大模型）等。 |
| voice_id              | 是   | String  | 音频流唯一标识（推荐UUID，最长128位），每次连接需重新生成。          |
| signature             | 是   | String  | 接口签名（计算方法见下文）。                                         |
| （其他可选参数）      | 否   | -       | 如voice_format、needvad、hotword_list等（详见完整参数表）。           |

### signature 签名生成

1. **拼接签名原文**：
    对除 `signature` 之外的所有参数按字典序进行排序，拼接请求 URL（不包含协议部分：`wss://`）作为签名原文。
    以 `appid=125922***`，`secretid=*****Qq1zhZMN8dv0*****` 为例，拼接的签名原文为：

    ```
    asr.cloud.tencent.com/asr/v2/125922***?engine_model_type=16k_zh&expired=1673494772&needvad=1&nonce=167
    ```

2. **HMAC-SHA1 加密与 Base64 编码**：
    对签名原文使用 `SecretKey` 进行 **HMAC-SHA1** 加密，之后再进行 `base64` 编码。
    以 `secretkey=*****SkqpeHgqmSz*****` 为例，对第一步的签名原文加密并编码处理：

    ```
    Base64Encode(HmacSha1("asr.cloud.tencent.com/asr/v2/125922***?engine_model_type=16k_zh&expired=1673494"))
    ```

    得到 `signature` 签名值为：

    ```
    G8jDQBRg1JfeBi/YnTjyjekxfDA=
    ```

3. **URL 编码与最终请求 URL**：
    将 `signature` 值进行 `urlencode`（需支持对 `+`、`=` 等特殊字符编码，否则可能鉴权失败），拼接得到最终请求 URL：

    ```
    wss://asr.cloud.tencent.com/asr/v2/125922***?engine_model_type=16k_zh&expired=1592380492&filter_dirty
    ```

#### 握手响应

- 成功：`{"code":0,"message":"success","voice_id":"<voice_id>"}`。
- 失败：返回非0code及错误信息（如`{"code":4002,"message":"鉴权失败"}`），并断开连接。

### 2. 识别阶段（上传音频与接收结果）

#### 上传音频数据

- 数据类型：二进制消息（binary message），内容为音频原始二进制数据。
- 结束标识：发送文本消息 `{"type": "end"}` 通知服务器。

#### Opus音频流特殊封装（仅opus格式）

| 字段           | 长度（字节） | 内容描述                  |
|----------------|--------------|---------------------------|
| OpusHead       | 4            | 固定为"opus"（ASCII编码） |
| 帧数据长度     | 2            | 后续Opus压缩数据的长度    |
| Opus压缩数据   | 可变         | 对应长度的opus二进制数据  |

#### 接收识别结果（文本消息）

##### 通用字段

| 字段名       | 类型    | 描述                                 |
|--------------|---------|--------------------------------------|
| code         | Integer | 状态码（0为正常，非0为错误）。       |
| voice_id     | String  | 音频流标识（与请求一致）。           |
| result       | Object  | 识别结果（识别中返回）。             |
| final        | Integer | 1表示整个音频流识别结束（最终消息）。 |

##### Result结构体（识别结果）

| 字段名           | 类型       | 描述                                                                 |
|------------------|------------|----------------------------------------------------------------------|
| slice_type       | Integer    | 结果类型：0（段落开始）、1（识别中，结果可能变化）、2（段落结束，结果稳定）。 |
| voice_text_str   | String     | 识别文本（UTF8编码）。                                               |
| start_time/end_time | Integer | 起始/结束时间（毫秒）。                                               |

## 四、错误码说明

| 错误码 | 描述说明                                 | 处理建议                                   |
|--------|------------------------------------------|--------------------------------------------|
| 4000   | 音频发送过多（1秒内超过3秒数据）         | 降低发送速率，按1:1实时率发送。             |
| 4002   | 鉴权失败                                 | 重新生成签名，检查secretid、timestamp等。   |
| 4007   | 音频解码失败（格式与参数不一致）         | 检查音频格式与voice_format是否匹配。       |
| 4008   | 客户端超过15秒未发送数据                 | 确保网络稳定，及时发送音频。               |
| 5000-5002 | 服务器偶发错误                           | 重新发起识别。                             |

## 五、开发者资源

- **SDK支持**：Go、Java、C++、Python、JS、C#等。
- **示例代码**：各语言调用示例可参考官网链接。
